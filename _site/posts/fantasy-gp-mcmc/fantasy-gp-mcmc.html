<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kiril Zvezdarov">
<meta name="dcterms.date" content="2023-08-31">

<title>kzvezdarov.github.io - Modeling Formula 1 Fantasy GP points with PyMC</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">kzvezdarov.github.io</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kzvezdarov" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Modeling Formula 1 Fantasy GP points with PyMC</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">python</div>
                <div class="quarto-category">pymc</div>
                <div class="quarto-category">formula1</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Kiril Zvezdarov </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 31, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data-acquisition" id="toc-data-acquisition" class="nav-link active" data-scroll-target="#data-acquisition"><span class="header-section-number">1</span> Data acquisition</a></li>
  <li><a href="#fantasy-points" id="toc-fantasy-points" class="nav-link" data-scroll-target="#fantasy-points"><span class="header-section-number">2</span> Fantasy points</a></li>
  <li><a href="#data-exploration" id="toc-data-exploration" class="nav-link" data-scroll-target="#data-exploration"><span class="header-section-number">3</span> Data exploration</a></li>
  <li><a href="#unpooled-model" id="toc-unpooled-model" class="nav-link" data-scroll-target="#unpooled-model"><span class="header-section-number">4</span> Unpooled model</a>
  <ul class="collapse">
  <li><a href="#picking-the-likelihood" id="toc-picking-the-likelihood" class="nav-link" data-scroll-target="#picking-the-likelihood"><span class="header-section-number">4.1</span> Picking the likelihood</a></li>
  <li><a href="#choosing-the-priors" id="toc-choosing-the-priors" class="nav-link" data-scroll-target="#choosing-the-priors"><span class="header-section-number">4.2</span> Choosing the priors</a></li>
  <li><a href="#model-definition" id="toc-model-definition" class="nav-link" data-scroll-target="#model-definition"><span class="header-section-number">4.3</span> Model definition</a></li>
  <li><a href="#prior-predictive-checks" id="toc-prior-predictive-checks" class="nav-link" data-scroll-target="#prior-predictive-checks"><span class="header-section-number">4.4</span> Prior predictive checks</a></li>
  <li><a href="#inference-and-diagnostics" id="toc-inference-and-diagnostics" class="nav-link" data-scroll-target="#inference-and-diagnostics"><span class="header-section-number">4.5</span> Inference and diagnostics</a></li>
  <li><a href="#posterior-predictive-checks" id="toc-posterior-predictive-checks" class="nav-link" data-scroll-target="#posterior-predictive-checks"><span class="header-section-number">4.6</span> Posterior predictive checks</a></li>
  <li><a href="#posterior-evaluation" id="toc-posterior-evaluation" class="nav-link" data-scroll-target="#posterior-evaluation"><span class="header-section-number">4.7</span> Posterior evaluation</a></li>
  <li><a href="#model-evaluation" id="toc-model-evaluation" class="nav-link" data-scroll-target="#model-evaluation"><span class="header-section-number">4.8</span> Model evaluation</a></li>
  </ul></li>
  <li><a href="#zero-inflated-unpooled-model" id="toc-zero-inflated-unpooled-model" class="nav-link" data-scroll-target="#zero-inflated-unpooled-model"><span class="header-section-number">5</span> Zero-inflated unpooled model</a>
  <ul class="collapse">
  <li><a href="#choosing-priors" id="toc-choosing-priors" class="nav-link" data-scroll-target="#choosing-priors"><span class="header-section-number">5.1</span> Choosing priors</a></li>
  <li><a href="#model-definition-1" id="toc-model-definition-1" class="nav-link" data-scroll-target="#model-definition-1"><span class="header-section-number">5.2</span> Model definition</a></li>
  <li><a href="#prior-evaluation" id="toc-prior-evaluation" class="nav-link" data-scroll-target="#prior-evaluation"><span class="header-section-number">5.3</span> Prior evaluation</a></li>
  <li><a href="#inference-and-diagnostics-1" id="toc-inference-and-diagnostics-1" class="nav-link" data-scroll-target="#inference-and-diagnostics-1"><span class="header-section-number">5.4</span> Inference and diagnostics</a></li>
  <li><a href="#posterior-predictive-checks-1" id="toc-posterior-predictive-checks-1" class="nav-link" data-scroll-target="#posterior-predictive-checks-1"><span class="header-section-number">5.5</span> Posterior predictive checks</a></li>
  <li><a href="#posterior-evaluation-1" id="toc-posterior-evaluation-1" class="nav-link" data-scroll-target="#posterior-evaluation-1"><span class="header-section-number">5.6</span> Posterior evaluation</a></li>
  <li><a href="#model-comparison" id="toc-model-comparison" class="nav-link" data-scroll-target="#model-comparison"><span class="header-section-number">5.7</span> Model comparison</a></li>
  </ul></li>
  <li><a href="#driver-estimates" id="toc-driver-estimates" class="nav-link" data-scroll-target="#driver-estimates"><span class="header-section-number">6</span> Driver estimates</a></li>
  <li><a href="#constructor-estimates" id="toc-constructor-estimates" class="nav-link" data-scroll-target="#constructor-estimates"><span class="header-section-number">7</span> Constructor estimates</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">8</span> Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> enum <span class="im">import</span> Enum</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, category<span class="op">=</span><span class="pp">UserWarning</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> preliz <span class="im">as</span> pz</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tqdm</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>sns.set_theme()</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>sns.set_style(style<span class="op">=</span><span class="st">"darkgrid"</span>, rc<span class="op">=</span>{<span class="st">"axes.facecolor"</span>: <span class="st">".9"</span>, <span class="st">"grid.color"</span>: <span class="st">".8"</span>})</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>sns.set_palette(palette<span class="op">=</span><span class="st">"deep"</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>sns_c <span class="op">=</span> sns.color_palette(palette<span class="op">=</span><span class="st">"deep"</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"figure.figsize"</span>] <span class="op">=</span> [<span class="dv">10</span>, <span class="dv">7</span>]</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>az.style.use(<span class="st">"arviz-docgrid"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING (pytensor.tensor.blas): Using NumPy C-API based implementation for BLAS functions.</code></pre>
</div>
</div>
<p>Like many others I got into Formula 1 after binging through <a href="https://en.wikipedia.org/wiki/Formula_1:_Drive_to_Survive">Drive to Survive</a>. After enduring a nail biting (and ultimately bitterly disappointing) 2021 season, and attending the 2022 Canadian Grand Prix, I organized a small fantasy league for 2023, hosted on <a href="https://fantasygp.com/">Fantasy GP</a>.</p>
<p>Fantasy GP’s rules give each player a set budget to build a team consisting of 3 drivers and 3 constructor. During the season, drivers and constructors are awarded points for position finished during at the race (matching the actual world championship points awarded), as well as for bonuses such as beating their teammate and gaining positions during the race. This effectively brings lower midfied and backmarker drivers into the mix, since they can generate points from performance relative to their rivals.</p>
<p>This notebook will attempt to model individual driver and constructor performance in terms of Fantasy GP points earned, in order to provide a slightly more quantifiable basis for team construction. We focus on the most fundamental question - how many points per race is a given driver/constructor likely to earn. To answer this, we will create and evaluate a simple Bayesian linear model using the probabilistic programming framework <a href="https://www.pymc.io/welcome.html">PyMC</a>.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Disclaimer
</div>
</div>
<div class="callout-body-container callout-body">
<p>I have a fairly limited knowledge of Bayesian statistics and modeling; this notebook shouldn’t be considered authoritative of prescriptive in any way. It is mostly a collection of notes, reflecting ongoing learning.</p>
</div>
</div>
<section id="data-acquisition" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="data-acquisition"><span class="header-section-number">1</span> Data acquisition</h2>
<p>We start by acquiring data for the 2023 season. The <a href="http://ergast.com/mrd/">Ergast API</a> hosts statistics for Formula 1 races from the 1950s to the present day and exposes convenient endpoints for querying both <a href="http://ergast.com/mrd/methods/qualifying/">qualifying</a> and <a href="http://ergast.com/mrd/methods/results/">grand prix results</a>.</p>
<p>First, we define some convenience functions to query the raw json data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>API <span class="op">=</span> <span class="st">"http://ergast.com/api/f1"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>DATASET_PATH <span class="op">=</span> {<span class="st">"gp"</span>: <span class="st">"results"</span>, <span class="st">"quali"</span>: <span class="st">"qualifying"</span>}</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_dataset(dataset: <span class="bu">str</span>, year: <span class="bu">int</span>, limit: <span class="bu">int</span> <span class="op">=</span> <span class="dv">10000</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    path <span class="op">=</span> DATASET_PATH[dataset]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>API<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">.json?limit=</span><span class="sc">{</span>limit<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(url)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    response.raise_for_status()</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response.json()</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_dataset(dataset: <span class="bu">str</span>, year: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    results_path <span class="op">=</span> Path(<span class="ss">f".data/</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>dataset<span class="sc">}</span><span class="ss">_results.json"</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> results_path.exists():</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> results_path.<span class="bu">open</span>() <span class="im">as</span> f:</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>            results <span class="op">=</span> json.loads(f.read())</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> get_dataset(dataset, year)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.isdir(<span class="st">".data"</span>):</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>            os.makedirs(<span class="st">".data"</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> results_path.<span class="bu">open</span>(<span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>            f.write(json.dumps(results))</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>gp_data <span class="op">=</span> load_dataset(<span class="st">"gp"</span>, <span class="dv">2023</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>quali_data <span class="op">=</span> load_dataset(<span class="st">"quali"</span>, <span class="dv">2023</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we unnest it into a row-wise format and load it as a Pandas dataframe for ease of use:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gp_results_to_dataframe(json_data):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> {}</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> gp <span class="kw">in</span> json_data[<span class="st">"MRData"</span>][<span class="st">"RaceTable"</span>][<span class="st">"Races"</span>]:</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> result <span class="kw">in</span> gp[<span class="st">"Results"</span>]:</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>            data.setdefault(<span class="st">"circuit"</span>, []).append(gp[<span class="st">"Circuit"</span>][<span class="st">"circuitId"</span>])</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>            data.setdefault(<span class="st">"driver"</span>, []).append(result[<span class="st">"Driver"</span>][<span class="st">"code"</span>])</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>            data.setdefault(<span class="st">"round"</span>, []).append(gp[<span class="st">"round"</span>])</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>            data.setdefault(<span class="st">"constructor"</span>, []).append(</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                result[<span class="st">"Constructor"</span>][<span class="st">"constructorId"</span>]</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>            data.setdefault(<span class="st">"grid"</span>, []).append(result[<span class="st">"grid"</span>])</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>            data.setdefault(<span class="st">"position"</span>, []).append(result[<span class="st">"position"</span>])</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>            data.setdefault(<span class="st">"points"</span>, []).append(result[<span class="st">"points"</span>])</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            data.setdefault(<span class="st">"fastest_lap"</span>, []).append(</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>                result.get(<span class="st">"FastestLap"</span>, {}).get(<span class="st">"rank"</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>            data.setdefault(<span class="st">"status"</span>, []).append(result[<span class="st">"status"</span>])</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame(data)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        .astype(</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">"circuit"</span>: <span class="st">"category"</span>,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"driver"</span>: <span class="st">"category"</span>,</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">"round"</span>: <span class="st">"int"</span>,</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">"constructor"</span>: <span class="st">"category"</span>,</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">"status"</span>: <span class="st">"category"</span>,</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"grid"</span>: <span class="st">"Int64"</span>,</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">"position"</span>: <span class="st">"Int64"</span>,</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>                <span class="st">"points"</span>: <span class="st">"float32"</span>,</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fastest_lap"</span>: <span class="st">"Int64"</span>,</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        .set_index([<span class="st">"circuit"</span>, <span class="st">"driver"</span>])</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quali_results_to_dataframe(json_data):</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> {}</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> quali <span class="kw">in</span> json_data[<span class="st">"MRData"</span>][<span class="st">"RaceTable"</span>][<span class="st">"Races"</span>]:</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> result <span class="kw">in</span> quali[<span class="st">"QualifyingResults"</span>]:</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>            data.setdefault(<span class="st">"circuit"</span>, []).append(quali[<span class="st">"Circuit"</span>][<span class="st">"circuitId"</span>])</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>            data.setdefault(<span class="st">"driver"</span>, []).append(result[<span class="st">"Driver"</span>][<span class="st">"code"</span>])</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>            data.setdefault(<span class="st">"round"</span>, []).append(quali[<span class="st">"round"</span>])</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>            data.setdefault(<span class="st">"constructor"</span>, []).append(</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>                result[<span class="st">"Constructor"</span>][<span class="st">"constructorId"</span>]</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>            data.setdefault(<span class="st">"qualifying_position"</span>, []).append(result[<span class="st">"position"</span>])</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame(data)</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>        .astype(</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>                <span class="st">"circuit"</span>: <span class="st">"category"</span>,</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>                <span class="st">"driver"</span>: <span class="st">"category"</span>,</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>                <span class="st">"round"</span>: <span class="st">"int"</span>,</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>                <span class="st">"constructor"</span>: <span class="st">"category"</span>,</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>                <span class="st">"qualifying_position"</span>: <span class="st">"Int64"</span>,</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>        .set_index([<span class="st">"circuit"</span>, <span class="st">"driver"</span>])</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>gp_df <span class="op">=</span> gp_results_to_dataframe(gp_data)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>gp_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">round</th>
<th data-quarto-table-cell-role="th">constructor</th>
<th data-quarto-table-cell-role="th">grid</th>
<th data-quarto-table-cell-role="th">position</th>
<th data-quarto-table-cell-role="th">points</th>
<th data-quarto-table-cell-role="th">fastest_lap</th>
<th data-quarto-table-cell-role="th">status</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">circuit</th>
<th data-quarto-table-cell-role="th">driver</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">bahrain</td>
<td data-quarto-table-cell-role="th">VER</td>
<td>1</td>
<td>red_bull</td>
<td>1</td>
<td>1</td>
<td>25.0</td>
<td>6</td>
<td>Finished</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PER</td>
<td>1</td>
<td>red_bull</td>
<td>2</td>
<td>2</td>
<td>18.0</td>
<td>7</td>
<td>Finished</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ALO</td>
<td>1</td>
<td>aston_martin</td>
<td>5</td>
<td>3</td>
<td>15.0</td>
<td>5</td>
<td>Finished</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">SAI</td>
<td>1</td>
<td>ferrari</td>
<td>4</td>
<td>4</td>
<td>12.0</td>
<td>14</td>
<td>Finished</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">HAM</td>
<td>1</td>
<td>mercedes</td>
<td>7</td>
<td>5</td>
<td>10.0</td>
<td>10</td>
<td>Finished</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">zandvoort</td>
<td data-quarto-table-cell-role="th">MAG</td>
<td>13</td>
<td>haas</td>
<td>0</td>
<td>16</td>
<td>0.0</td>
<td>17</td>
<td>Finished</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">RUS</td>
<td>13</td>
<td>mercedes</td>
<td>3</td>
<td>17</td>
<td>0.0</td>
<td>14</td>
<td>Finished</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ZHO</td>
<td>13</td>
<td>alfa</td>
<td>5</td>
<td>18</td>
<td>0.0</td>
<td>16</td>
<td>Accident</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">LEC</td>
<td>13</td>
<td>ferrari</td>
<td>9</td>
<td>19</td>
<td>0.0</td>
<td>19</td>
<td>Undertray</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">SAR</td>
<td>13</td>
<td>williams</td>
<td>10</td>
<td>20</td>
<td>0.0</td>
<td>20</td>
<td>Accident</td>
</tr>
</tbody>
</table>

<p>260 rows × 7 columns</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>quali_df <span class="op">=</span> quali_results_to_dataframe(quali_data)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>quali_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">round</th>
<th data-quarto-table-cell-role="th">constructor</th>
<th data-quarto-table-cell-role="th">qualifying_position</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">circuit</th>
<th data-quarto-table-cell-role="th">driver</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">bahrain</td>
<td data-quarto-table-cell-role="th">VER</td>
<td>1</td>
<td>red_bull</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PER</td>
<td>1</td>
<td>red_bull</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">LEC</td>
<td>1</td>
<td>ferrari</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">SAI</td>
<td>1</td>
<td>ferrari</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ALO</td>
<td>1</td>
<td>aston_martin</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">zandvoort</td>
<td data-quarto-table-cell-role="th">ZHO</td>
<td>13</td>
<td>alfa</td>
<td>16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">OCO</td>
<td>13</td>
<td>alpine</td>
<td>17</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">MAG</td>
<td>13</td>
<td>haas</td>
<td>18</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">BOT</td>
<td>13</td>
<td>alfa</td>
<td>19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">LAW</td>
<td>13</td>
<td>alphatauri</td>
<td>20</td>
</tr>
</tbody>
</table>

<p>260 rows × 3 columns</p>
</div>
</div>
</div>
<p>Finally, we join the grand prix and qualifying dataframes together, forming the base dataset for our analysis; we also rename all entries credited to Liam Lawson (LAW) to Daniel Ricciardio (RIC), as Fantasy GP credits points from the temporary reserve driver to the driver they replace:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>data_df <span class="op">=</span> gp_df.join(quali_df[[<span class="st">"qualifying_position"</span>]]).rename(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    level<span class="op">=</span><span class="st">"driver"</span>, index<span class="op">=</span>{<span class="st">"LAW"</span>: <span class="st">"RIC"</span>}</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>data_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">round</th>
<th data-quarto-table-cell-role="th">constructor</th>
<th data-quarto-table-cell-role="th">grid</th>
<th data-quarto-table-cell-role="th">position</th>
<th data-quarto-table-cell-role="th">points</th>
<th data-quarto-table-cell-role="th">fastest_lap</th>
<th data-quarto-table-cell-role="th">status</th>
<th data-quarto-table-cell-role="th">qualifying_position</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">circuit</th>
<th data-quarto-table-cell-role="th">driver</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">bahrain</td>
<td data-quarto-table-cell-role="th">VER</td>
<td>1</td>
<td>red_bull</td>
<td>1</td>
<td>1</td>
<td>25.0</td>
<td>6</td>
<td>Finished</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PER</td>
<td>1</td>
<td>red_bull</td>
<td>2</td>
<td>2</td>
<td>18.0</td>
<td>7</td>
<td>Finished</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ALO</td>
<td>1</td>
<td>aston_martin</td>
<td>5</td>
<td>3</td>
<td>15.0</td>
<td>5</td>
<td>Finished</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">SAI</td>
<td>1</td>
<td>ferrari</td>
<td>4</td>
<td>4</td>
<td>12.0</td>
<td>14</td>
<td>Finished</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">HAM</td>
<td>1</td>
<td>mercedes</td>
<td>7</td>
<td>5</td>
<td>10.0</td>
<td>10</td>
<td>Finished</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">zandvoort</td>
<td data-quarto-table-cell-role="th">MAG</td>
<td>13</td>
<td>haas</td>
<td>0</td>
<td>16</td>
<td>0.0</td>
<td>17</td>
<td>Finished</td>
<td>18</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">RUS</td>
<td>13</td>
<td>mercedes</td>
<td>3</td>
<td>17</td>
<td>0.0</td>
<td>14</td>
<td>Finished</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ZHO</td>
<td>13</td>
<td>alfa</td>
<td>5</td>
<td>18</td>
<td>0.0</td>
<td>16</td>
<td>Accident</td>
<td>16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">LEC</td>
<td>13</td>
<td>ferrari</td>
<td>9</td>
<td>19</td>
<td>0.0</td>
<td>19</td>
<td>Undertray</td>
<td>9</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">SAR</td>
<td>13</td>
<td>williams</td>
<td>10</td>
<td>20</td>
<td>0.0</td>
<td>20</td>
<td>Accident</td>
<td>10</td>
</tr>
</tbody>
</table>

<p>260 rows × 8 columns</p>
</div>
</div>
</div>
</section>
<section id="fantasy-points" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="fantasy-points"><span class="header-section-number">2</span> Fantasy points</h2>
<p>Fantasy GP points per team/driver are <a href="https://fantasygp.com/about/guide/">calculated in the following way</a>: * drivers earn the points scored during the grand prix, 10pts for taking pole position, 2pts per position gained on Sunday, and 5 points each for beating their teammate during qualifying and the race itself. * constructors earn the points scored by each of their drivers during the grand prix, 1pt per position gained per driver, 5 points if both cars finish, 2 if only one car finishes.</p>
<p>To simplify the problem, we completely ignore sprint races (as should everyone).</p>
<p>The race finish status classification has several detailed categories:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>data_df[<span class="st">"status"</span>].dtype</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>CategoricalDtype(categories=['+1 Lap', '+2 Laps', 'Accident', 'Brakes', 'Collision',
                  'Collision damage', 'Electrical', 'Engine', 'Finished',
                  'Mechanical', 'Oil leak', 'Overheating', 'Power loss',
                  'Retired', 'Undertray'],
, ordered=False, categories_dtype=object)</code></pre>
</div>
</div>
<p>Fantasy GP scoring only cares whether a car finished or not, so we define the following set of categories to indiciate a finish:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>STATUS_FINISHED <span class="op">=</span> [<span class="st">"Finished"</span>, <span class="st">"+1 Lap"</span>, <span class="st">"+2 Laps"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>While our dataset has the WDC points scored per driver/constructor already, positions gained and performance vs.&nbsp;teammate need to be added in:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_scoring_cols(df: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.assign(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Grid value of 0 indicates pit lane start; here we set that to 99</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># to simplify the check for who won out in qualifying.</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        grid<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"grid"</span>].where(x[<span class="st">"grid"</span>] <span class="op">!=</span> <span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    ).assign(</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Positions gained compared to the starting grid position; scoring doesn't</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># care about positions lost, so we set anything below 0 to 0.</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        positions_gained<span class="op">=</span><span class="kw">lambda</span> x: np.maximum(x[<span class="st">"grid"</span>] <span class="op">-</span> x[<span class="st">"position"</span>], <span class="dv">0</span>),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Whether the driver won pole position</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        has_pole<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"qualifying_position"</span>] <span class="op">==</span> <span class="dv">1</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Whether the driver beat their teammate in qualifying</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        beat_teammate_quali<span class="op">=</span><span class="kw">lambda</span> x: x.groupby(</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Each group is per race, per constructor, so only 2 rows - one for each driver.</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>            [<span class="st">"circuit"</span>, <span class="st">"constructor"</span>],</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>            group_keys<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        ).<span class="bu">apply</span>(</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Smaller grid pos. = better; the grid position is compared</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># to the reversed grid array in the group (essentially</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># we create a cartesian product of the grid pos.)</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> g: g[<span class="st">"grid"</span>]</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span> g[<span class="st">"grid"</span>].iloc[::<span class="op">-</span><span class="dv">1</span>].values</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Same as the previous column, but for finishing position in the race.</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>        beat_teammate_race<span class="op">=</span><span class="kw">lambda</span> x: x.groupby(</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>            [<span class="st">"circuit"</span>, <span class="st">"constructor"</span>], group_keys<span class="op">=</span><span class="va">False</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        ).<span class="bu">apply</span>(</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> g: (g[<span class="st">"position"</span>] <span class="op">&lt;</span> g[<span class="st">"position"</span>].iloc[::<span class="op">-</span><span class="dv">1</span>].values)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> g[<span class="st">"status"</span>].isin(STATUS_FINISHED)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>        has_fastest_lap<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"fastest_lap"</span>] <span class="op">==</span> <span class="dv">1</span>,</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>data_df <span class="op">=</span> add_scoring_cols(data_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This leaves us with the following dataframe:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>data_df[</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"grid"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"positions_gained"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beat_teammate_quali"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beat_teammate_race"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"has_pole"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"has_fastest_lap"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">grid</th>
<th data-quarto-table-cell-role="th">positions_gained</th>
<th data-quarto-table-cell-role="th">beat_teammate_quali</th>
<th data-quarto-table-cell-role="th">beat_teammate_race</th>
<th data-quarto-table-cell-role="th">has_pole</th>
<th data-quarto-table-cell-role="th">has_fastest_lap</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">circuit</th>
<th data-quarto-table-cell-role="th">driver</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">bahrain</td>
<td data-quarto-table-cell-role="th">VER</td>
<td>1</td>
<td>0</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PER</td>
<td>2</td>
<td>0</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ALO</td>
<td>5</td>
<td>2</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">SAI</td>
<td>4</td>
<td>0</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">HAM</td>
<td>7</td>
<td>2</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">zandvoort</td>
<td data-quarto-table-cell-role="th">MAG</td>
<td>20</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">RUS</td>
<td>3</td>
<td>0</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ZHO</td>
<td>5</td>
<td>0</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">LEC</td>
<td>9</td>
<td>0</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">SAR</td>
<td>10</td>
<td>0</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
</tbody>
</table>

<p>260 rows × 6 columns</p>
</div>
</div>
</div>
<p>Finally, we can score the Fantasy GP points; we define the scoring function for the driver to be the sum of: - WDC points - 10 for gaining pole position - 5 for outqualifying their teammate - 5 for outracing their teammate - 2 per position gained at the end of the race</p>
<p>Note that a driver who did not finish the race on Sunday can still earn points from the qualifying session.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_driver(x):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        x[<span class="st">"has_pole"</span>] <span class="op">*</span> <span class="dv">10</span> <span class="op">+</span> x[<span class="st">"beat_teammate_quali"</span>] <span class="op">*</span> <span class="dv">5</span>, dtype<span class="op">=</span><span class="bu">float</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span> pd.Series(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        x[<span class="st">"points"</span>] <span class="op">+</span> x[<span class="st">"positions_gained"</span>] <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> x[<span class="st">"beat_teammate_race"</span>] <span class="op">*</span> <span class="dv">5</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        dtype<span class="op">=</span><span class="bu">float</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    ).where(</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        x[<span class="st">"status"</span>].isin(STATUS_FINISHED), <span class="dv">0</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Scoring for the constructors is defined as: - WDC points - 5 points if both cars finished, 2 if only one did - 1 point per position gained at the end of the race per car</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_constructor(x):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    finished <span class="op">=</span> x[<span class="st">"status"</span>].isin(STATUS_FINISHED)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">match</span> finished.<span class="bu">sum</span>():</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="dv">2</span>:</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>            finish_bonus <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="dv">1</span>:</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>            finish_bonus <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> _:</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>            finish_bonus <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x[<span class="st">"points"</span>].<span class="bu">sum</span>() <span class="op">+</span> x[finished][<span class="st">"positions_gained"</span>].<span class="bu">sum</span>() <span class="op">+</span> finish_bonus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Just from the rules definition it is clear that drivers have a higher points earnign ceiling but much higher variance, whereas constructors are more consistent but earn fewer points.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_fantasy_points(df: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.assign(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>        driver_points<span class="op">=</span>score_driver,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Constructor points need to be joined back in on the grouping columns, in order to</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fill in the missing spots with duplicate values - since we have 20 drivers, but 10 constructors,</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the group has fewer rows and needs to be broadcast per group on the index.</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        constructor_points<span class="op">=</span><span class="kw">lambda</span> x: x.join(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>            x.groupby([<span class="st">"circuit"</span>, <span class="st">"constructor"</span>])</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>            .<span class="bu">apply</span>(score_constructor)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>            .rename(<span class="st">"constructor_points"</span>),</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span>[<span class="st">"circuit"</span>, <span class="st">"constructor"</span>],</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        )[<span class="st">"constructor_points"</span>],</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The scored dataframe looks like this:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>data_df <span class="op">=</span> score_fantasy_points(data_df)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>data_df[[<span class="st">"driver_points"</span>, <span class="st">"constructor_points"</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">driver_points</th>
<th data-quarto-table-cell-role="th">constructor_points</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">circuit</th>
<th data-quarto-table-cell-role="th">driver</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">bahrain</td>
<td data-quarto-table-cell-role="th">VER</td>
<td>45.0</td>
<td>48.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PER</td>
<td>18.0</td>
<td>48.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ALO</td>
<td>29.0</td>
<td>32.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">SAI</td>
<td>17.0</td>
<td>14.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">HAM</td>
<td>19.0</td>
<td>23.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">zandvoort</td>
<td data-quarto-table-cell-role="th">MAG</td>
<td>8.0</td>
<td>11.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">RUS</td>
<td>5.0</td>
<td>20.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ZHO</td>
<td>5.0</td>
<td>6.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">LEC</td>
<td>0.0</td>
<td>13.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">SAR</td>
<td>0.0</td>
<td>6.0</td>
</tr>
</tbody>
</table>

<p>260 rows × 2 columns</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The constructor points are duplicated per race, since we broadcast those across both drivers.</p>
</div>
</div>
</section>
<section id="data-exploration" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="data-exploration"><span class="header-section-number">3</span> Data exploration</h2>
<p>Now we visualize the data to get a better idea of its properties. First, some basic box plots for each driver/constructor:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"ticks"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>f, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>sns.boxplot(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data_df.reset_index(),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"driver_points"</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"driver"</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">"pastel"</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    whis<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">100</span>],</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>sns.stripplot(</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"driver_points"</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"driver"</span>,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>data_df.reset_index(),</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"circuit"</span>,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    dodge<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">"muted"</span>,</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>ax.xaxis.grid(<span class="va">True</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">"points"</span>)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Driver Fantasy GP points 2023"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>For convenience, we create a constructor-specific dataframe by taking the first row for each constructor for each race. This gets rid of the duplicate data (as constructor points were duplicated across both drivers):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>const_data_df <span class="op">=</span> data_df.groupby([<span class="st">"circuit"</span>, <span class="st">"constructor"</span>]).first().reset_index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"ticks"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>f, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>sns.boxplot(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>const_data_df.reset_index(),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"constructor_points"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"constructor"</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">"pastel"</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    whis<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">100</span>],</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>sns.stripplot(</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"constructor_points"</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"constructor"</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>const_data_df.reset_index(),</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"circuit"</span>,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">"muted"</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    dodge<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>ax.xaxis.grid(<span class="va">True</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">"points"</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Constructor Fantasy GP points 2023"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-21-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>These look quite similar and expose the brutal reality of Red Bull’s total dominance over the field. Matching our intuition from the rules definition, drivers appear to earn more and have wider variance in points scored, comapred to teams, with the exception of Max Verstappen and his absurd consistency.</p>
<p>Next, we plot the kernel density estimate of the driver points to gain a better idea of the overall distribution:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.displot(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    data_df.reset_index(),</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"driver_points"</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    col<span class="op">=</span><span class="st">"driver"</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    kind<span class="op">=</span><span class="st">"kde"</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    rug<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    col_wrap<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    fill<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>g.set_axis_labels(<span class="st">"points"</span>, <span class="st">"density"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-22-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.displot(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    const_data_df.reset_index(),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"constructor_points"</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    col<span class="op">=</span><span class="st">"constructor"</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    col_wrap<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    kind<span class="op">=</span><span class="st">"kde"</span>,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    rug<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    fill<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>g.set_axis_labels(<span class="st">"points"</span>, <span class="st">"density"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The distribution of points is spread and somewhat multi-peaked in both cases; again, constructors appear score in a much more consistent range compared to drivers. The pooled observed points distributions are:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>f, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(data_df.reset_index(), x<span class="op">=</span><span class="st">"driver_points"</span>, fill<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>axs[<span class="dv">0</span>])</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(const_data_df.reset_index(), x<span class="op">=</span><span class="st">"constructor_points"</span>, fill<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>axs[<span class="dv">1</span>])</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].set_title(<span class="st">"Overall driver points density 2023"</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">"driver points"</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].set_title(<span class="st">"Overall constructor points density 2023"</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">"constructor points"</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>f.tight_layout()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-24-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Given that the point distributions between drivers and constructors appear very similar, we’ll focus on constructing models of the driver points, which we can later fit to the constructor data with minor adjustments.</p>
</section>
<section id="unpooled-model" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="unpooled-model"><span class="header-section-number">4</span> Unpooled model</h2>
<p>Our first model will be the simplest possible - we just directly estimate the mean points for each driver individually (an intercept-only, unpooled linear model).</p>
<section id="picking-the-likelihood" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="picking-the-likelihood"><span class="header-section-number">4.1</span> Picking the likelihood</h3>
<p>The points data has several properties that stem from the Fantasy GP ruleset: - points are discrete - points are strictly bound between 0 and 84 (25 for p1 + 1 for fastest lap + 10 for pole position + 10 for beating teammate + 19 * 2 for maximum possible positions gained) - most drivers have a few 0 point finishes, but overall it’s very unlikely for a driver to score 0 points consistently.</p>
<p>Because we are modeling discrete, strictly positive points, one of the count distributions is likely an appropriate choice for the likelihood. The <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.Poisson.html">Poisson</a> distribution could be a good choice, but the observations appear overdispersed, as measured by the <a href="https://en.wikipedia.org/wiki/Index_of_dispersion">coefficient of dispersion</a>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>data_df <span class="op">=</span> data_df.reset_index().astype(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"circuit"</span>: <span class="st">"category"</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"driver"</span>: <span class="st">"category"</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>dispersion <span class="op">=</span> (</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    data_df.groupby(<span class="st">"driver"</span>)[<span class="st">"driver_points"</span>].var()</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> data_df.groupby(<span class="st">"driver"</span>)[<span class="st">"driver_points"</span>].mean()</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>dispersion</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>driver
ALB     2.158586
ALO     2.270430
BOT     4.930283
DEV     2.808279
GAS    13.610345
HAM     1.934783
HUL     3.598765
LEC     8.770227
MAG     4.777778
NOR     6.144891
OCO     7.162602
PER     3.986537
PIA     6.518519
RIC     2.818182
RUS     6.504785
SAI     4.422156
SAR     7.111111
STR     5.604167
TSU     2.145695
VER     1.028269
ZHO     7.261111
Name: driver_points, dtype: float64</code></pre>
</div>
</div>
<p>Given that, we will pick the <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.NegativeBinomial.html">Negative Binomial</a> as our likelihood, since it handles overdispersion better<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
</section>
<section id="choosing-the-priors" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="choosing-the-priors"><span class="header-section-number">4.2</span> Choosing the priors</h3>
<p>A <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.NegativeBinomial.html">Negative Binomial</a> likelihood is defined by two parameters - its mean μ, and a shape parameter α. We’ll need to set priors on both.</p>
<p>The mean is restricted to be positive only. The standard way of defining a negative binomial linear model is to set a Normal prior on the mean and use the exponentiation as the inverse link function to make it positive and usable for parameterizing the likelihood. For the actual prior parameters it would be reasonable to go with a fairly uninformative prior, such as <code>Normal(mu=0, sigma=1)</code>; in this case, prior knowledge and the ruleset gives us a hunch that we can reasonably expect most drivers’ mean points per race to be somewhere between 5 (backmarker, occasionally beats their teammate, maybe gains a place) and 30 (top driver &amp; team, consistently getting and winning from pole position).</p>
<p>To come up with parameter values for this, we use the <a href="https://preliz.readthedocs.io/en/latest/">PreliZ</a> library to find a maximum entropy <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.Normal.html">Normal</a> distribution with 90% of its mass between 5 and 30 (we take the natural log of those, given the exponential inverse link):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>mu_dist <span class="op">=</span> pz.Normal()</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>pz.maxent(mu_dist, np.log(<span class="dv">5</span>), np.log(<span class="dv">30</span>), <span class="fl">0.90</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-26-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The shape parameter α is also strictly positive. Its effect on the likelihood can be best understood by plotting a <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.NegativeBinomial.html">Negative Binomial</a> for a few different values, while keeping the mean fixed:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>f, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>pz.NegativeBinomial(alpha<span class="op">=</span><span class="fl">0.5</span>, mu<span class="op">=</span><span class="dv">15</span>).plot_pdf(ax<span class="op">=</span>axs[<span class="dv">0</span>, <span class="dv">0</span>], legend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="ss">f"Negative Binomial with μ: 15, α: 0.5"</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>pz.NegativeBinomial(alpha<span class="op">=</span><span class="dv">5</span>, mu<span class="op">=</span><span class="dv">15</span>).plot_pdf(ax<span class="op">=</span>axs[<span class="dv">0</span>, <span class="dv">1</span>], legend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="ss">f"Negative Binomial with μ: 15, α: 5"</span>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>pz.NegativeBinomial(alpha<span class="op">=</span><span class="dv">50</span>, mu<span class="op">=</span><span class="dv">15</span>).plot_pdf(ax<span class="op">=</span>axs[<span class="dv">1</span>, <span class="dv">0</span>], legend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="ss">f"Negative Binomial with μ: 15, α: 50"</span>)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>pz.NegativeBinomial(alpha<span class="op">=</span><span class="dv">500</span>, mu<span class="op">=</span><span class="dv">15</span>).plot_pdf(ax<span class="op">=</span>axs[<span class="dv">1</span>, <span class="dv">1</span>], legend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="ss">f"Negative Binomial with μ: 15, α: 500"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-27-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>As α increases, the tails shrink. We don’t want very high values, as that will restrict the tails too much, but very small values result in absurdly long tails. To handle that, we use a <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.Gamma.html">Gamma</a> distribution, with mass strongly concentrated between 1 and 20:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>alpha_dist <span class="op">=</span> pz.Gamma()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>pz.maxent(alpha_dist, <span class="dv">1</span>, <span class="dv">20</span>, <span class="fl">.9</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Finally, we prepare the data for use within the model. We factorize the <code>driver</code> column into labels and an index:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>idx, labels <span class="op">=</span> pd.factorize(data_df[<span class="st">"driver"</span>], sort<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>labels</code> is a categorical variable over the driver names:</p>
<div class="cell">
<div class="cell-output cell-output-display">
<pre><code>CategoricalIndex(['ALB', 'ALO', 'BOT', 'DEV', 'GAS', 'HAM', 'HUL', 'LEC',
                  'MAG', 'NOR', 'OCO', 'PER', 'PIA', 'RIC', 'RUS', 'SAI',
                  'SAR', 'STR', 'TSU', 'VER', 'ZHO'],
                 categories=['ALB', 'ALO', 'BOT', 'DEV', ..., 'STR', 'TSU', 'VER', 'ZHO'], ordered=False, dtype='category')</code></pre>
</div>
</div>
<p><code>idx</code> is the flattened (race number, driver) index into the observed race result rows:</p>
<div class="cell">
<div class="cell-output cell-output-display">
<pre><code>array([19, 11,  1, 15,  5, 17, 14,  2,  4,  0, 18, 16,  8,  3,  6, 20,  9,
       10,  7, 12, 11, 19,  1, 14,  5, 15,  7, 10,  4,  8, 18,  6, 20,  3,
       12, 16,  9,  2,  0, 17, 19,  5,  1, 17, 11,  9,  6, 12, 20, 18,  2,
       15,  4, 10,  3, 16,  8, 14,  0,  7, 11, 19,  7,  1, 15,  5, 17, 14,
        9, 18, 12,  0,  8,  4, 10, 16,  6,  2, 20,  3, 19, 11,  1, 14, 15,
        5,  7,  4, 10,  8, 18, 17,  2,  0,  6, 20,  9,  3, 12, 16, 19,  1,
       10,  5, 14,  7,  4, 15,  9, 12,  2,  3, 20,  0, 18, 11,  6, 16,  8,
       17, 19,  5, 14, 11, 15, 17,  1, 10, 20,  4,  7, 18, 12,  3,  6,  0,
        9,  8,  2, 16, 19,  1,  5,  7, 15, 11,  0, 10, 17,  2, 12,  4,  9,
       18,  6, 20,  8,  3, 14, 16, 19,  7, 11,  9,  1, 15, 14,  5, 17,  4,
        0, 20, 16, 10,  2, 12,  3,  8, 18,  6, 19,  9,  5, 12, 14, 11,  1,
        0,  7, 15, 16,  2,  6, 17, 20, 18,  3,  4,  8, 10, 19,  9, 11,  5,
       12, 14,  7, 15,  1, 17,  0,  2, 13,  6, 18, 20,  8, 16, 10,  4, 19,
       11,  7,  5,  1, 14,  9, 10, 17, 18,  4,  2, 20,  0,  8, 13, 16,  6,
       15, 12, 19,  1,  4, 11, 15,  5,  9,  0, 12, 10, 17,  6, 13,  2, 18,
        8, 14, 20,  7, 16])</code></pre>
</div>
</div>
<p>We also extract the observed points:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>driver_points <span class="op">=</span> data_df[<span class="st">"driver_points"</span>]</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>driver_points</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0      45.0
1      18.0
2      29.0
3      17.0
4      19.0
       ... 
255     8.0
256     5.0
257     5.0
258     0.0
259     0.0
Name: driver_points, Length: 260, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="model-definition" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="model-definition"><span class="header-section-number">4.3</span> Model definition</h3>
<p>Next, we define the model with <a href="https://www.pymc.io/">PyMC</a>. As discussed previously, we think that the process that generates points can be seen as a Negative Binomial distribution, so that is set as the likelihood. The mean (μ) аnd shape (α) are the parameters that we want to infer from the data. Finally, the prior guesses for these parameters are set from the <code>mu_dist</code> and <code>alpha_dist</code> objects we computed previously.</p>
<p>This translates to:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(coords<span class="op">=</span>{<span class="st">"driver"</span>: labels, <span class="st">"idx"</span>: idx}) <span class="im">as</span> unpooled_negb:</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    μ <span class="op">=</span> pm.Normal(<span class="st">"μ"</span>, mu_dist.mu, mu_dist.sigma, dims<span class="op">=</span><span class="st">"driver"</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    μ_ <span class="op">=</span> pm.Deterministic(<span class="st">"μ_"</span>, pm.math.exp(μ), dims<span class="op">=</span><span class="st">"driver"</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    α <span class="op">=</span> pm.Gamma(<span class="st">"α"</span>, alpha_dist.alpha, alpha_dist.beta, dims<span class="op">=</span><span class="st">"driver"</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> pm.NegativeBinomial(</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"y"</span>, alpha<span class="op">=</span>α[idx], mu<span class="op">=</span>μ_[idx], observed<span class="op">=</span>driver_points, dims<span class="op">=</span><span class="st">"idx"</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prior-predictive-checks" class="level3" data-number="4.4">
<h3 data-number="4.4" class="anchored" data-anchor-id="prior-predictive-checks"><span class="header-section-number">4.4</span> Prior predictive checks</h3>
<p>To see if the choice for priors is acceptable, we sample from the prior predictive and plot the results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> unpooled_negb:</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    unpooled_prior_samples <span class="op">=</span> pm.sample_prior_predictive(samples<span class="op">=</span><span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [y, α, μ]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>az.plot_ppc(unpooled_prior_samples, group<span class="op">=</span><span class="st">"prior"</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-35-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The prior predictive is quite wide, with a very long and somewhat fat tail, but overall the data could be plausibly seen as coming from it.</p>
</section>
<section id="inference-and-diagnostics" class="level3" data-number="4.5">
<h3 data-number="4.5" class="anchored" data-anchor-id="inference-and-diagnostics"><span class="header-section-number">4.5</span> Inference and diagnostics</h3>
<p>Next, we perform the actual inference step - we sample from the posterior and the posterior predictive distribution:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> unpooled_negb:</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    unpooled_idata <span class="op">=</span> pm.sample(target_accept<span class="op">=</span><span class="fl">0.9</span>, idata_kwargs<span class="op">=</span>{<span class="st">"log_likelihood"</span>: <span class="va">True</span>})</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    pm.sample_posterior_predictive(unpooled_idata, extend_inferencedata<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [μ, α]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 5 seconds.
Sampling: [y]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:04&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="4000" class="" max="4000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [4000/4000 00:00&lt;00:00]
    </div>
    
</div>
</div>
<p>There are no divergences detected, which is a good first sign that the model has converged.</p>
<p>To check the sampling process we plot the traces for the μ parameter. What we are looking for is similar densities on the left (indicating that the chains have converged to the same posterior distribution), and noisy/patternless trace plots on the right (which would indicate that the sampler was able to efficiently run through the sample space)<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>az.plot_trace(unpooled_idata, var_names<span class="op">=</span>[<span class="st">"μ"</span>], compact<span class="op">=</span><span class="va">False</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-37-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>There are a few kinks here and there (see RIC), but overall these look good.</p>
<p>Next we plot the <a href="https://python.arviz.org/en/latest/api/generated/arviz.plot_energy.html#r74895e2d4323-1">energy plot</a> and <a href="https://python.arviz.org/en/latest/api/generated/arviz.bfmi.html#arviz.bfmi">BFMI</a>. Ideally the marginal energy and energy transition distributions should overlap as much as possible, and BFMI should be to be above .3:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> az.plot_energy(unpooled_idata)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Energy Plot"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-38-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Finally, we check the summary statistics for the μ parameter: - bulk and tail effective sample size (<code>ess_bulk</code> and <code>ess_tail</code> respectively) should be &gt; 400, otherwise the estimation of the rest of the summary statistics is considered unreliable <a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> - <code>r_hat</code> should ideally equal 1, with values over 1.01 convergence issues <a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> - <code>mcse_{mean, sd}</code> is the Monte Carlo Standard Error, or the error introduced by approximating the posterior with a finite number of samples; lower = better <a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>az.summary(unpooled_idata, var_names<span class="op">=</span>[<span class="st">"μ"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_3%</th>
<th data-quarto-table-cell-role="th">hdi_97%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[ALB]</td>
<td>2.536</td>
<td>0.117</td>
<td>2.330</td>
<td>2.761</td>
<td>0.002</td>
<td>0.001</td>
<td>4320.0</td>
<td>2693.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[ALO]</td>
<td>3.153</td>
<td>0.102</td>
<td>2.959</td>
<td>3.339</td>
<td>0.002</td>
<td>0.001</td>
<td>4155.0</td>
<td>2788.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[BOT]</td>
<td>2.476</td>
<td>0.195</td>
<td>2.127</td>
<td>2.876</td>
<td>0.003</td>
<td>0.002</td>
<td>3924.0</td>
<td>2310.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[DEV]</td>
<td>1.761</td>
<td>0.214</td>
<td>1.347</td>
<td>2.150</td>
<td>0.003</td>
<td>0.002</td>
<td>4724.0</td>
<td>2339.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[GAS]</td>
<td>2.448</td>
<td>0.243</td>
<td>2.000</td>
<td>2.917</td>
<td>0.004</td>
<td>0.003</td>
<td>4174.0</td>
<td>2716.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[HAM]</td>
<td>3.119</td>
<td>0.097</td>
<td>2.936</td>
<td>3.303</td>
<td>0.002</td>
<td>0.001</td>
<td>4028.0</td>
<td>2484.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[HUL]</td>
<td>2.156</td>
<td>0.163</td>
<td>1.842</td>
<td>2.461</td>
<td>0.003</td>
<td>0.002</td>
<td>3949.0</td>
<td>2420.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[LEC]</td>
<td>2.732</td>
<td>0.216</td>
<td>2.339</td>
<td>3.152</td>
<td>0.003</td>
<td>0.002</td>
<td>4608.0</td>
<td>3103.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[MAG]</td>
<td>2.082</td>
<td>0.272</td>
<td>1.568</td>
<td>2.578</td>
<td>0.005</td>
<td>0.004</td>
<td>3401.0</td>
<td>2402.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[NOR]</td>
<td>2.716</td>
<td>0.155</td>
<td>2.430</td>
<td>3.027</td>
<td>0.002</td>
<td>0.002</td>
<td>4446.0</td>
<td>2606.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[OCO]</td>
<td>2.329</td>
<td>0.254</td>
<td>1.873</td>
<td>2.814</td>
<td>0.004</td>
<td>0.003</td>
<td>3931.0</td>
<td>2496.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[PER]</td>
<td>3.288</td>
<td>0.108</td>
<td>3.090</td>
<td>3.497</td>
<td>0.002</td>
<td>0.001</td>
<td>4118.0</td>
<td>2353.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[PIA]</td>
<td>1.940</td>
<td>0.296</td>
<td>1.358</td>
<td>2.476</td>
<td>0.005</td>
<td>0.004</td>
<td>4082.0</td>
<td>2374.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[RIC]</td>
<td>2.421</td>
<td>0.259</td>
<td>1.960</td>
<td>2.920</td>
<td>0.004</td>
<td>0.003</td>
<td>3907.0</td>
<td>2528.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[RUS]</td>
<td>2.753</td>
<td>0.174</td>
<td>2.437</td>
<td>3.092</td>
<td>0.003</td>
<td>0.002</td>
<td>4625.0</td>
<td>2669.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[SAI]</td>
<td>2.554</td>
<td>0.173</td>
<td>2.228</td>
<td>2.865</td>
<td>0.003</td>
<td>0.002</td>
<td>4475.0</td>
<td>2856.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[SAR]</td>
<td>1.917</td>
<td>0.472</td>
<td>1.040</td>
<td>2.794</td>
<td>0.007</td>
<td>0.005</td>
<td>4408.0</td>
<td>3437.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[STR]</td>
<td>2.203</td>
<td>0.280</td>
<td>1.707</td>
<td>2.748</td>
<td>0.005</td>
<td>0.004</td>
<td>3535.0</td>
<td>2543.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[TSU]</td>
<td>2.455</td>
<td>0.120</td>
<td>2.220</td>
<td>2.671</td>
<td>0.002</td>
<td>0.001</td>
<td>4800.0</td>
<td>3020.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[VER]</td>
<td>3.747</td>
<td>0.076</td>
<td>3.599</td>
<td>3.892</td>
<td>0.001</td>
<td>0.001</td>
<td>4629.0</td>
<td>2855.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[ZHO]</td>
<td>2.290</td>
<td>0.239</td>
<td>1.839</td>
<td>2.736</td>
<td>0.004</td>
<td>0.003</td>
<td>4797.0</td>
<td>2443.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>All of the sampling diagnistics look good, which means the model has converged and we can move on to posterior predictive checks and model evaluation.</p>
</section>
<section id="posterior-predictive-checks" class="level3" data-number="4.6">
<h3 data-number="4.6" class="anchored" data-anchor-id="posterior-predictive-checks"><span class="header-section-number">4.6</span> Posterior predictive checks</h3>
<p>Next we examine the posterior predictive distribution, which will help validate that the predictions the model is making make sense given the data. Below we plot several posterior graphs (from top to bottom, left to right): - the (grouped) posterior predictive distribution should closely replicate the pattern seen in the observed data <a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> - the Bayesian p-value is the probability of the predicted data being equal to or less than the observed data. The ideal/expected outcome is represented by the dashed line (0.5), with the solid line being the KDE of the predicted data; the u-value represents the same idea as the p-value, but per observation - it should be roughly uniform <a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> - LOO-PIT is the probability integral transform checed with LOO-CV; this should be close to uniform; difference between LOO-PIT empirical cumulative distribution function and the uniform cdf <a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_posterior_predictive_checks(idata):</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">12</span>))</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    ax_ppc <span class="op">=</span> f.add_subplot(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    az.plot_ppc(idata, ax<span class="op">=</span>ax_ppc)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    ax_ppc.set_title(<span class="st">"Posterior predictive checks"</span>)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    ax_bpv <span class="op">=</span> f.add_subplot(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    az.plot_bpv(idata, kind<span class="op">=</span><span class="st">"p_value"</span>, ax<span class="op">=</span>ax_bpv)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    ax_bpv.set_title(<span class="st">"Bayesian p_value"</span>)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    ax_uv <span class="op">=</span> f.add_subplot(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    az.plot_bpv(idata, kind<span class="op">=</span><span class="st">"u_value"</span>, ax<span class="op">=</span>ax_uv)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    ax_uv.set_title(<span class="st">"Marginal p_value"</span>)</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    ax_loo_pit_ecdf <span class="op">=</span> f.add_subplot(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">5</span>)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    az.plot_loo_pit(idata, y<span class="op">=</span><span class="st">"y"</span>, ecdf<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>ax_loo_pit_ecdf)</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    ax_loo_pit_ecdf.set_title(<span class="st">"LOO-PIT (ecdf=True)"</span>)</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    ax_loo_pit <span class="op">=</span> f.add_subplot(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">6</span>)</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    az.plot_loo_pit(idata, y<span class="op">=</span><span class="st">"y"</span>, ecdf<span class="op">=</span><span class="va">False</span>, ax<span class="op">=</span>ax_loo_pit)</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    ax_loo_pit.set_title(<span class="st">"LOO-PIT (ecdf=False)"</span>)</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    f.tight_layout()</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (ax_ppc, ax_bpv, ax_uv, ax_loo_pit_ecdf, ax_loo_pit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>plot_posterior_predictive_checks(unpooled_idata)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-41-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>From the posterior predictive plots it seems that: - the posterior predictive samples roughly look like tha observed data, but the fit around the right tail isn’t the best. - the p-value plot shows that the model’s predictions are somewhat shifted to the right and the u-value plot indicates that the model is missing observations in the left tail <a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> - LOO-PIT shows the model is likely biased, which agrees with the p/u-value plots.</p>
<p>Lastly, let’s plot the posterior predictive distributions for a few individual drivers:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>DriverIdx <span class="op">=</span> Enum(<span class="st">"Driver"</span>, <span class="bu">zip</span>(labels.categories, labels.codes))</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>az.plot_ppc(unpooled_idata, coords<span class="op">=</span>{<span class="st">"idx"</span>: [DriverIdx.VER.value]}, ax<span class="op">=</span>axs[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">"VER"</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>az.plot_ppc(unpooled_idata, coords<span class="op">=</span>{<span class="st">"idx"</span>: [DriverIdx.SAR.value]}, ax<span class="op">=</span>axs[<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">"SAR"</span>)</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>az.plot_ppc(unpooled_idata, coords<span class="op">=</span>{<span class="st">"idx"</span>: [DriverIdx.LEC.value]}, ax<span class="op">=</span>axs[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">"LEC"</span>)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>az.plot_ppc(unpooled_idata, coords<span class="op">=</span>{<span class="st">"idx"</span>: [DriverIdx.HAM.value]}, ax<span class="op">=</span>axs[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">"HAM"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-42-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="posterior-evaluation" class="level3" data-number="4.7">
<h3 data-number="4.7" class="anchored" data-anchor-id="posterior-evaluation"><span class="header-section-number">4.7</span> Posterior evaluation</h3>
<p>We are reasonably confident that the model has converged and that there were no issues during sampling. Predictions seem to be somewhat biased, but still reasonable for our purposes. Now it’s time to check the posterior distributions of the estimated parameter μ:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>az.plot_posterior(unpooled_idata, var_names<span class="op">=</span>[<span class="st">"μ"</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-43-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The estimates look well formed; to make comparing the parameter value between drivers easier, we plot a forest of the 94% HDI <a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>az.plot_forest(unpooled_idata, var_names<span class="op">=</span>[<span class="st">"μ"</span>], combined<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-44-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The probability distributions for the means broadly agree with our informal observations throughout the season - VER is scoring high above the rest, in an extremely consistent range, with HAM, ALO, and PER close to eachother for second place, a mixed, variable set of results for the midfield, and a few clear backmarker drivers.</p>
<p>To translate the estimated parameter values to points, we can plot the transformed μ_ value (remember that this is just the exponentiated μ):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>az.plot_forest(unpooled_idata, var_names<span class="op">=</span>[<span class="st">"μ_"</span>], combined<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-45-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="model-evaluation" class="level3" data-number="4.8">
<h3 data-number="4.8" class="anchored" data-anchor-id="model-evaluation"><span class="header-section-number">4.8</span> Model evaluation</h3>
<p>Finally, we inspect <a href="https://python.arviz.org/en/stable/api/generated/arviz.loo.html">PSIS-LOO-CV</a> to get an idea of the performance of the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>az.loo(unpooled_idata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Computed from 4000 posterior samples and 260 observations log-likelihood matrix.

         Estimate       SE
elpd_loo  -889.76    14.58
p_loo       43.98        -
------

Pareto k diagnostic values:
                         Count   Pct.
(-Inf, 0.5]   (good)      254   97.7%
 (0.5, 0.7]   (ok)          6    2.3%
   (0.7, 1]   (bad)         0    0.0%
   (1, Inf)   (very bad)    0    0.0%</code></pre>
</div>
</div>
<p><code>elpd_loo</code> <a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a> will be more useful when comparing this baseline model to other, more complicated ones, but the fact that Pareto k values are all significantly below 0.7 is a good sign that the model can generalize decently.</p>
</section>
</section>
<section id="zero-inflated-unpooled-model" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="zero-inflated-unpooled-model"><span class="header-section-number">5</span> Zero-inflated unpooled model</h2>
<p>One of the common issues with both <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.Poisson.html#pymc.Poisson">Poisson</a> and <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.NegativeBinomial.html#pymc.NegativeBinomial">Negative Binomial</a> models is that they do not generate zeroes often enough. This can be alleviated by using a mixture model that inflates the number of zeroes, which <code>PyMC</code> already has an implementation of - the <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.ZeroInflatedNegativeBinomial.html">Zero Inflated Negative Binomial likelihood</a>.</p>
<p>To test that extra zeroes might result in a better fit, we define a new model with the same priors as before, but using the mixture likelihood. One additional parameter, ψ, is needed, so we have to set a prior over that. ψ is the probability of a non-zero value, between 0 and 1. We will use a <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.Beta.html">Beta</a> as the prior distribution, and given the ruleset and reliability of modern F1 cars, our prior belief is that 0 point finishes aren’t all that likely. To express that, we take the maximum entropy Beta whose mass is concentrated between .8 and .99:</p>
<section id="choosing-priors" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="choosing-priors"><span class="header-section-number">5.1</span> Choosing priors</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>psi_dist <span class="op">=</span> pz.Beta()</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>pz.maxent(psi_dist, <span class="fl">0.8</span>, <span class="fl">0.99</span>, <span class="fl">0.9</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-47-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="model-definition-1" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="model-definition-1"><span class="header-section-number">5.2</span> Model definition</h3>
<p>The new model is trivial to define:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(coords<span class="op">=</span>{<span class="st">"driver"</span>: labels, <span class="st">"idx"</span>: idx}) <span class="im">as</span> zi_unpooled_negb:</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    μ <span class="op">=</span> pm.Normal(<span class="st">"μ"</span>, mu_dist.mu, mu_dist.sigma, dims<span class="op">=</span><span class="st">"driver"</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    μ_ <span class="op">=</span> pm.Deterministic(<span class="st">"μ_"</span>, pm.math.exp(μ), dims<span class="op">=</span><span class="st">"driver"</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    α <span class="op">=</span> pm.Gamma(<span class="st">"α"</span>, alpha_dist.alpha, alpha_dist.beta, dims<span class="op">=</span><span class="st">"driver"</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    ψ <span class="op">=</span> pm.Beta(<span class="st">"ψ"</span>, psi_dist.alpha, psi_dist.beta, dims<span class="op">=</span><span class="st">"driver"</span>)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> pm.ZeroInflatedNegativeBinomial(</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"y"</span>,</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>        psi<span class="op">=</span>ψ[idx],</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>α[idx],</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>        mu<span class="op">=</span>μ_[idx],</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>        observed<span class="op">=</span>driver_points,</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">=</span><span class="st">"idx"</span>,</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prior-evaluation" class="level3" data-number="5.3">
<h3 data-number="5.3" class="anchored" data-anchor-id="prior-evaluation"><span class="header-section-number">5.3</span> Prior evaluation</h3>
<p>We perform the same prior predictive check:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> zi_unpooled_negb:</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    zi_unpooled_prior_samples <span class="op">=</span> pm.sample_prior_predictive(samples<span class="op">=</span><span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [y, α, μ, ψ]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>az.plot_ppc(zi_unpooled_prior_samples, group<span class="op">=</span><span class="st">"prior"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-50-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="inference-and-diagnostics-1" class="level3" data-number="5.4">
<h3 data-number="5.4" class="anchored" data-anchor-id="inference-and-diagnostics-1"><span class="header-section-number">5.4</span> Inference and diagnostics</h3>
<p>Sample:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> zi_unpooled_negb:</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    zi_unpooled_idata <span class="op">=</span> pm.sample(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>        target_accept<span class="op">=</span><span class="fl">0.9</span>, idata_kwargs<span class="op">=</span>{<span class="st">"log_likelihood"</span>: <span class="va">True</span>}</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    pm.sample_posterior_predictive(zi_unpooled_idata, extend_inferencedata<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [μ, α, ψ]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 10 seconds.
Sampling: [y]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:09&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="4000" class="" max="4000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [4000/4000 00:05&lt;00:00]
    </div>
    
</div>
</div>
<p>The traceplots look about as good as before:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>az.plot_trace(zi_unpooled_idata, var_names<span class="op">=</span>[<span class="st">"μ"</span>], compact<span class="op">=</span><span class="va">False</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-52-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>BFMI and energy are reasonable:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> az.plot_energy(zi_unpooled_idata)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Energy Plot"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-53-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><code>r_hat</code> and ESS look good as well:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>az.summary(zi_unpooled_idata, var_names<span class="op">=</span>[<span class="st">"μ"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_3%</th>
<th data-quarto-table-cell-role="th">hdi_97%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[ALB]</td>
<td>2.541</td>
<td>0.115</td>
<td>2.325</td>
<td>2.755</td>
<td>0.001</td>
<td>0.001</td>
<td>6059.0</td>
<td>2698.0</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[ALO]</td>
<td>3.153</td>
<td>0.100</td>
<td>2.952</td>
<td>3.332</td>
<td>0.001</td>
<td>0.001</td>
<td>6387.0</td>
<td>2362.0</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[BOT]</td>
<td>2.626</td>
<td>0.132</td>
<td>2.364</td>
<td>2.856</td>
<td>0.002</td>
<td>0.001</td>
<td>6166.0</td>
<td>2553.0</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[DEV]</td>
<td>1.905</td>
<td>0.182</td>
<td>1.574</td>
<td>2.251</td>
<td>0.002</td>
<td>0.002</td>
<td>6665.0</td>
<td>3017.0</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[GAS]</td>
<td>2.487</td>
<td>0.226</td>
<td>2.071</td>
<td>2.920</td>
<td>0.003</td>
<td>0.002</td>
<td>6241.0</td>
<td>2819.0</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[HAM]</td>
<td>3.118</td>
<td>0.095</td>
<td>2.927</td>
<td>3.285</td>
<td>0.001</td>
<td>0.001</td>
<td>5974.0</td>
<td>2642.0</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[HUL]</td>
<td>2.214</td>
<td>0.145</td>
<td>1.928</td>
<td>2.476</td>
<td>0.002</td>
<td>0.001</td>
<td>6685.0</td>
<td>2551.0</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[LEC]</td>
<td>2.900</td>
<td>0.152</td>
<td>2.615</td>
<td>3.188</td>
<td>0.002</td>
<td>0.001</td>
<td>5683.0</td>
<td>2455.0</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[MAG]</td>
<td>2.314</td>
<td>0.148</td>
<td>2.040</td>
<td>2.608</td>
<td>0.002</td>
<td>0.001</td>
<td>6671.0</td>
<td>2811.0</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[NOR]</td>
<td>2.718</td>
<td>0.155</td>
<td>2.430</td>
<td>3.012</td>
<td>0.002</td>
<td>0.001</td>
<td>7077.0</td>
<td>3085.0</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[OCO]</td>
<td>2.507</td>
<td>0.167</td>
<td>2.194</td>
<td>2.832</td>
<td>0.002</td>
<td>0.002</td>
<td>4580.0</td>
<td>2620.0</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[PER]</td>
<td>3.286</td>
<td>0.108</td>
<td>3.076</td>
<td>3.481</td>
<td>0.001</td>
<td>0.001</td>
<td>6277.0</td>
<td>3305.0</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[PIA]</td>
<td>2.108</td>
<td>0.209</td>
<td>1.678</td>
<td>2.471</td>
<td>0.003</td>
<td>0.002</td>
<td>6063.0</td>
<td>2942.0</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[RIC]</td>
<td>2.424</td>
<td>0.251</td>
<td>1.986</td>
<td>2.922</td>
<td>0.003</td>
<td>0.002</td>
<td>6185.0</td>
<td>2844.0</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[RUS]</td>
<td>2.838</td>
<td>0.149</td>
<td>2.552</td>
<td>3.110</td>
<td>0.002</td>
<td>0.001</td>
<td>6603.0</td>
<td>2818.0</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[SAI]</td>
<td>2.626</td>
<td>0.145</td>
<td>2.366</td>
<td>2.909</td>
<td>0.002</td>
<td>0.001</td>
<td>5862.0</td>
<td>2395.0</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[SAR]</td>
<td>2.095</td>
<td>0.250</td>
<td>1.583</td>
<td>2.540</td>
<td>0.004</td>
<td>0.003</td>
<td>4158.0</td>
<td>2271.0</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[STR]</td>
<td>2.450</td>
<td>0.141</td>
<td>2.191</td>
<td>2.723</td>
<td>0.002</td>
<td>0.001</td>
<td>6987.0</td>
<td>2586.0</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[TSU]</td>
<td>2.457</td>
<td>0.121</td>
<td>2.233</td>
<td>2.682</td>
<td>0.002</td>
<td>0.001</td>
<td>6605.0</td>
<td>2735.0</td>
<td>1.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[VER]</td>
<td>3.751</td>
<td>0.076</td>
<td>3.610</td>
<td>3.896</td>
<td>0.001</td>
<td>0.001</td>
<td>6206.0</td>
<td>2875.0</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[ZHO]</td>
<td>2.484</td>
<td>0.156</td>
<td>2.193</td>
<td>2.781</td>
<td>0.002</td>
<td>0.002</td>
<td>5348.0</td>
<td>2711.0</td>
<td>1.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="posterior-predictive-checks-1" class="level3" data-number="5.5">
<h3 data-number="5.5" class="anchored" data-anchor-id="posterior-predictive-checks-1"><span class="header-section-number">5.5</span> Posterior predictive checks</h3>
<p>Posterior predictive checks look somewhat better: - the posterior predictive fits about as well, with a slightly thinner tail - p-value is still shifted - u-value is much closer to uniform - LOO-PIT still suggests bias, but it looks slightly better overall; the right tail of the posterior predictive still looks too fat and goes well above the maximum points possible in the ruleset, likely causing the bias and shifted predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>plot_posterior_predictive_checks(zi_unpooled_idata)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-55-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="posterior-evaluation-1" class="level3" data-number="5.6">
<h3 data-number="5.6" class="anchored" data-anchor-id="posterior-evaluation-1"><span class="header-section-number">5.6</span> Posterior evaluation</h3>
<p>We plot just the forest of transformed means:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>az.plot_forest(zi_unpooled_idata, var_names<span class="op">=</span>[<span class="st">"μ_"</span>], combined<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-56-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>As expected, compared to the basic model, the means have been pulled towards zero slightly and the HDIs have shrunk.</p>
</section>
<section id="model-comparison" class="level3" data-number="5.7">
<h3 data-number="5.7" class="anchored" data-anchor-id="model-comparison"><span class="header-section-number">5.7</span> Model comparison</h3>
<p>Now that we have two models it’s worth running a comparison to see which performs better <a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>comparison <span class="op">=</span> az.compare(</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"unpooled"</span>: unpooled_idata, <span class="st">"zero inflated unpooled"</span>: zi_unpooled_idata}</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>comparison</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">elpd_loo</th>
<th data-quarto-table-cell-role="th">p_loo</th>
<th data-quarto-table-cell-role="th">elpd_diff</th>
<th data-quarto-table-cell-role="th">weight</th>
<th data-quarto-table-cell-role="th">se</th>
<th data-quarto-table-cell-role="th">dse</th>
<th data-quarto-table-cell-role="th">warning</th>
<th data-quarto-table-cell-role="th">scale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">zero inflated unpooled</td>
<td>0</td>
<td>-857.195803</td>
<td>37.556046</td>
<td>0.000000</td>
<td>0.860765</td>
<td>15.440698</td>
<td>0.000000</td>
<td>False</td>
<td>log</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">unpooled</td>
<td>1</td>
<td>-889.761483</td>
<td>43.984838</td>
<td>32.565679</td>
<td>0.139235</td>
<td>14.581579</td>
<td>10.665155</td>
<td>False</td>
<td>log</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>az.plot_compare(comparison)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-58-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The zero-inflated model clearly seems to perform better <a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a>.</p>
</section>
</section>
<section id="driver-estimates" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="driver-estimates"><span class="header-section-number">6</span> Driver estimates</h2>
<p>We have a reasonable looking, if a bit biased model for driver points, which we’ll now use to inform fantasy team construction.</p>
<p>When picking drivers, we consider the following: - how many points per race is the driver expected to bring and how reliably - how likely is it that a given driver will outperform another driver, and by what magnitude - how underpriced/overpriced is a a driver given their performance</p>
<p>While price analysis is out of the scope of this notebook, the points estimation model can help us with the first two questions.</p>
<p>Below, we compare each driver to their rivals, using the difference of predicted points per race. To do so, we take the predictions generated from the posterior predictive distribution for each driver, subtract the two vectors, and take the mean. This reduces the posterior distributions to a point estimate, but still incorporates the uncertainty of the model, as we work directly with values generated from the posterior. The value can be seen both as confidence driver x is better than driver y - higher is better, and as the points we expect driver x to earn over driver y on average.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>The plot below isn’t symmetric over the right diagonal - we are strictly comparing the driver on the X axis to the driver on the Y axis.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_comparison(idata, idx, groups, size<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    columns <span class="op">=</span> {}</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx_a, name_a <span class="kw">in</span> <span class="bu">enumerate</span>(groups):</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx_b, name_b <span class="kw">in</span> <span class="bu">enumerate</span>(groups):</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>            pp_a <span class="op">=</span> idata.posterior_predictive[<span class="st">"y"</span>][:, :, idx <span class="op">==</span> idx_a].values.flatten()</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>            pp_b <span class="op">=</span> idata.posterior_predictive[<span class="st">"y"</span>][:, :, idx <span class="op">==</span> idx_b].values.flatten()</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>            samples_a <span class="op">=</span> np.random.choice(pp_a, size<span class="op">=</span>size)</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>            samples_b <span class="op">=</span> np.random.choice(pp_b, size<span class="op">=</span>size)</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> idx_a <span class="op">!=</span> idx_b:</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>                points_over <span class="op">=</span> (samples_a <span class="op">-</span> samples_b).mean()</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>                points_over <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>            columns.setdefault(name_a, []).append(points_over)</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>    comparison_df <span class="op">=</span> pd.DataFrame.from_dict(columns).set_index(groups)</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> np.triu(np.ones_like(comparison_df, dtype<span class="op">=</span><span class="bu">bool</span>))</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> comparison_df, mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>comparison_df, mask <span class="op">=</span> make_comparison(zi_unpooled_idata, idx, labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"white"</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>cmap <span class="op">=</span> sns.diverging_palette(<span class="dv">230</span>, <span class="dv">20</span>, as_cmap<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>f, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">11</span>, <span class="dv">9</span>))</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.heatmap(</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    comparison_df,</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span>cmap,</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    mask<span class="op">=</span>mask,</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    annot<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    center<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    square<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    linewidths<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    cbar_kws<span class="op">=</span>{<span class="st">"shrink"</span>: <span class="fl">0.5</span>},</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>    annot_kws<span class="op">=</span>{<span class="st">"fontsize"</span>: <span class="dv">8</span>},</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>).<span class="bu">set</span>(title<span class="op">=</span><span class="st">"Driver points expected over rival"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-61-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="constructor-estimates" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="constructor-estimates"><span class="header-section-number">7</span> Constructor estimates</h2>
<p>We’ll run the same loop for the constructor comparison - first we define a slightly modified zero inflated model, then we sample, validate convergence, and finally use the posterior and posterior predictive to evaluate constructor peformance.</p>
<p>Data preparation is identical - we factorize the constructors and take the points</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>const_idx, const_labels <span class="op">=</span> pd.factorize(const_data_df[<span class="st">"constructor"</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>const_points <span class="op">=</span> const_data_df[<span class="st">"constructor_points"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We adjust the priors slightly, to account for differences in the constructors scoring system:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>mu_const_dist <span class="op">=</span> pz.Normal()</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>pz.maxent(mu_const_dist, np.log(<span class="dv">2</span>), np.log(<span class="dv">30</span>), <span class="fl">0.9</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-63-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>alpha_const_dist <span class="op">=</span> pz.Gamma()</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>pz.maxent(alpha_const_dist, <span class="dv">1</span>, <span class="dv">10</span>, <span class="fl">.9</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-64-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>psi_const_dist <span class="op">=</span> pz.Beta()</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>pz.maxent(psi_const_dist, <span class="fl">.9</span>, <span class="fl">.99</span>, <span class="fl">.9</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-65-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    coords<span class="op">=</span>{<span class="st">"constructor"</span>: const_labels, <span class="st">"idx"</span>: const_idx}</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>) <span class="im">as</span> const_zi_unpooled_model:</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    μ <span class="op">=</span> pm.Normal(<span class="st">"μ"</span>, mu_const_dist.mu, mu_const_dist.sigma, dims<span class="op">=</span><span class="st">"constructor"</span>)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    μ_ <span class="op">=</span> pm.Deterministic(<span class="st">"μ_"</span>, pm.math.exp(μ), dims<span class="op">=</span><span class="st">"constructor"</span>)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    α <span class="op">=</span> pm.Gamma(<span class="st">"α"</span>, alpha_const_dist.alpha, alpha_const_dist.beta, dims<span class="op">=</span><span class="st">"constructor"</span>)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    ψ <span class="op">=</span> pm.Beta(<span class="st">"ψ"</span>, psi_const_dist.alpha, psi_const_dist.beta, dims<span class="op">=</span><span class="st">"constructor"</span>)</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> pm.ZeroInflatedNegativeBinomial(</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"y"</span>,</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>        psi<span class="op">=</span>ψ[const_idx],</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>α[const_idx],</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>        mu<span class="op">=</span>μ_[const_idx],</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>        observed<span class="op">=</span>const_points,</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">=</span><span class="st">"idx"</span>,</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> const_zi_unpooled_model:</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    const_prior_pred <span class="op">=</span> pm.sample_prior_predictive(samples<span class="op">=</span><span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [y, α, μ, ψ]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>az.plot_ppc(const_prior_pred, group<span class="op">=</span><span class="st">"prior"</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-68-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> const_zi_unpooled_model:</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    const_idata <span class="op">=</span> pm.sample(target_accept<span class="op">=</span><span class="fl">0.9</span>, idata_kwargs<span class="op">=</span>{<span class="st">"log_likelihood"</span>: <span class="va">True</span>})</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    pm.sample_posterior_predictive(const_idata, extend_inferencedata<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [μ, α, ψ]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 6 seconds.
Sampling: [y]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:05&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="4000" class="" max="4000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [4000/4000 00:03&lt;00:00]
    </div>
    
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>az.plot_trace(const_idata, var_names<span class="op">=</span>[<span class="st">"μ"</span>], compact<span class="op">=</span><span class="va">False</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-70-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>plot_posterior_predictive_checks(const_idata)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-71-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>az.loo(const_idata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Computed from 4000 posterior samples and 130 observations log-likelihood matrix.

         Estimate       SE
elpd_loo  -439.75     9.32
p_loo       11.94        -
------

Pareto k diagnostic values:
                         Count   Pct.
(-Inf, 0.5]   (good)      130  100.0%
 (0.5, 0.7]   (ok)          0    0.0%
   (0.7, 1]   (bad)         0    0.0%
   (1, Inf)   (very bad)    0    0.0%</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>az.plot_forest(const_idata, var_names<span class="op">=</span>[<span class="st">"μ_"</span>], combined<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-73-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"white"</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>cmap <span class="op">=</span> sns.diverging_palette(<span class="dv">230</span>, <span class="dv">20</span>, as_cmap<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>f, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">11</span>, <span class="dv">9</span>))</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>comparison_df, mask <span class="op">=</span> make_comparison(const_idata, const_idx, const_labels)</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.heatmap(</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>    comparison_df,</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span>cmap,</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>    mask<span class="op">=</span>mask,</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>    annot<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>    center<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>    square<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    linewidths<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>    cbar_kws<span class="op">=</span>{<span class="st">"shrink"</span>: <span class="fl">0.5</span>},</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>    annot_kws<span class="op">=</span>{<span class="st">"fontsize"</span>: <span class="dv">8</span>},</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>).<span class="bu">set</span>(title<span class="op">=</span><span class="st">"Constructor points expected over rival"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="fantasy-gp-mcmc_files/figure-html/cell-74-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="conclusion" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">8</span> Conclusion</h2>
<p>None of the results here are that surprising, but it’s nonetheless useful to confirm our intuition for who’s a good pick and who isn’t. That said, the estimates should be taken with more than a grain of salt - the model we used is quite rudimentary (for one, it doesn’t account for performance trends as the season progresses), and modeling the summed fantasy points directly leads to a lot of detail getting obscured and left out.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext watermark</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>watermark <span class="op">-</span>n <span class="op">-</span>u <span class="op">-</span>v <span class="op">-</span>iv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The watermark extension is already loaded. To reload it, use:
  %reload_ext watermark
Last updated: Mon Sep 04 2023

Python implementation: CPython
Python version       : 3.11.4
IPython version      : 8.14.0

sys       : 3.11.4 (main, Jun 28 2023, 19:51:46) [GCC]
scipy     : 1.10.1
requests  : 2.31.0
numpy     : 1.25.2
pandas    : 2.1.0
arviz     : 0.16.1
preliz    : 0.3.2
pymc      : 5.7.2
seaborn   : 0.12.2
matplotlib: 3.7.2
json      : 2.0.9
tqdm      : 4.66.1
</code></pre>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>see the intro to this for more details: https://www.pymc.io/projects/examples/en/latest/generalized_linear_models/GLM-negative-binomial-regression.html<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>see this for a quick summary of model checking techniques: https://www.pymc.io/projects/docs/en/stable/learn/core_notebooks/pymc_overview.html#model-checking<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>see: https://bayesiancomputationbook.com/markdown/chp_02.html#effective-sample-size<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>see: https://bayesiancomputationbook.com/markdown/chp_02.html#potential-scale-reduction-factor-hat-r<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>see: https://bayesiancomputationbook.com/markdown/chp_02.html#monte-carlo-standard-error<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>see: https://bayesiancomputationbook.com/markdown/chp_02.html#understanding-your-predictions<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>see: https://bayesiancomputationbook.com/markdown/chp_02.html#fig-posterior-predictive-check-pu-values<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>see: https://oriolabrilpla.cat/en/blog/posts/2019/loo-pit-tutorial.html<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>for a detailed guide on interpreting the bpv plots see: https://bayesiancomputationbook.com/markdown/chp_02.html#fig-posterior-predictive-many-examples<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>see: https://sjster.github.io/introduction_to_computational_statistics/docs/Production/PyMC3.html#hdi<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>see: https://bayesiancomputationbook.com/markdown/chp_02.html#cross-validation-and-loo<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p>see: https://bayesiancomputationbook.com/markdown/chp_02.html#model-comparison<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13"><p>for much more information on cross validation see: https://avehtari.github.io/modelselection/CV-FAQ.html#12_What_is_the_interpretation_of_ELPD__elpd_loo__elpd_diff<a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>
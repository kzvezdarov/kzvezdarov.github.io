<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Kiril Zvezdarov&#39;s Blog</title>
<link>https://kirilzvezdarov.com/</link>
<atom:link href="https://kirilzvezdarov.com/index.xml" rel="self" type="application/rss+xml"/>
<description>Kiril Zvezdarov&#39;s Blog</description>
<generator>quarto-1.4.550</generator>
<lastBuildDate>Thu, 31 Aug 2023 04:00:00 GMT</lastBuildDate>
<item>
  <title>Modeling Formula 1 Fantasy GP points with PyMC</title>
  <dc:creator>Kiril Zvezdarov</dc:creator>
  <link>https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc.html</link>
  <description><![CDATA[ 





<section id="modeling-formula-1-fantasy-gp-points-with-pymc" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Modeling Formula 1 Fantasy GP points with PyMC</h1>
<div id="11dd86a5-e957-4822-af94-42309cfdb83d" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>matplotlib inline</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> json</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> warnings</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> enum <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Enum</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb1-8"></span>
<span id="cb1-9">warnings.filterwarnings(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ignore"</span>, category<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">UserWarning</span>)</span>
<span id="cb1-10">warnings.filterwarnings(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ignore"</span>, category<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">FutureWarning</span>)</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> arviz <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> az</span>
<span id="cb1-13"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-15"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> preliz <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pz</span>
<span id="cb1-16"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pymc <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pm</span>
<span id="cb1-17"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb1-18"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-19"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb1-20"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-21"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> stats</span>
<span id="cb1-22"></span>
<span id="cb1-23">sns.set_theme()</span>
<span id="cb1-24">sns.set_style(style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgrid"</span>, rc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"axes.facecolor"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".9"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grid.color"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".8"</span>})</span>
<span id="cb1-25">sns.set_palette(palette<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deep"</span>)</span>
<span id="cb1-26">sns_c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.color_palette(palette<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deep"</span>)</span>
<span id="cb1-27"></span>
<span id="cb1-28">plt.rcParams[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"figure.figsize"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>]</span>
<span id="cb1-29"></span>
<span id="cb1-30">az.style.use(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"arviz-docgrid"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING (pytensor.tensor.blas): Using NumPy C-API based implementation for BLAS functions.</code></pre>
</div>
</div>
<p>Like many others I got into Formula 1 after binging through <a href="https://en.wikipedia.org/wiki/Formula_1:_Drive_to_Survive">Drive to Survive</a>. After enduring a nail biting (and ultimately bitterly disappointing) 2021 season, and attending the 2022 Canadian Grand Prix, I organized a small fantasy league for 2023, hosted on <a href="https://fantasygp.com/">Fantasy GP</a>.</p>
<p>Fantasy GP’s rules give each player a set budget to build a team consisting of 3 drivers and 3 constructor. During the season, drivers and constructors are awarded points for position finished during at the race (matching the actual world championship points awarded), as well as for bonuses such as beating their teammate and gaining positions during the race. This effectively brings lower midfied and backmarker drivers into the mix, since they can generate points from performance relative to their rivals.</p>
<p>This notebook will attempt to model individual driver and constructor performance in terms of Fantasy GP points earned, in order to provide a slightly more quantifiable basis for team construction. We focus on the most fundamental question - how many points per race is a given driver/constructor likely to earn. To answer this, we will create and evaluate a simple Bayesian linear model using the probabilistic programming framework <a href="https://www.pymc.io/welcome.html">PyMC</a>.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Disclaimer
</div>
</div>
<div class="callout-body-container callout-body">
<p>I have a fairly limited knowledge of Bayesian statistics and modeling; this notebook shouldn’t be considered authoritative of prescriptive in any way. It is mostly a collection of notes, reflecting ongoing learning.</p>
</div>
</div>
<section id="data-acquisition" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="data-acquisition"><span class="header-section-number">1.1</span> Data acquisition</h2>
<p>We start by acquiring data for the 2023 season. The <a href="http://ergast.com/mrd/">Ergast API</a> hosts statistics for Formula 1 races from the 1950s to the present day and exposes convenient endpoints for querying both <a href="http://ergast.com/mrd/methods/qualifying/">qualifying</a> and <a href="http://ergast.com/mrd/methods/results/">grand prix results</a>.</p>
<p>First, we define some convenience functions to query the raw json data:</p>
<div id="0bd7f0a2-e72f-4dad-bec6-1df50ad66617" class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">API <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://ergast.com/api/f1"</span></span></code></pre></div>
</div>
<div id="96e95017-4888-4cf2-b9bd-6fdfed9d8b97" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">DATASET_PATH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gp"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"results"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quali"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qualifying"</span>}</span>
<span id="cb4-2"></span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_dataset(dataset: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, year: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, limit: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb4-5">    path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DATASET_PATH[dataset]</span>
<span id="cb4-6">    url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>API<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>year<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.json?limit=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>limit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb4-7"></span>
<span id="cb4-8">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.get(url)</span>
<span id="cb4-9">    response.raise_for_status()</span>
<span id="cb4-10"></span>
<span id="cb4-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> response.json()</span>
<span id="cb4-12"></span>
<span id="cb4-13"></span>
<span id="cb4-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> load_dataset(dataset: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, year: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb4-15">    results_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f".data/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>year<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>dataset<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_results.json"</span>)</span>
<span id="cb4-16"></span>
<span id="cb4-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> results_path.exists():</span>
<span id="cb4-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> results_path.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>() <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb4-19">            results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> json.loads(f.read())</span>
<span id="cb4-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb4-21">        results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_dataset(dataset, year)</span>
<span id="cb4-22"></span>
<span id="cb4-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> os.path.isdir(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".data"</span>):</span>
<span id="cb4-24">            os.makedirs(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".data"</span>)</span>
<span id="cb4-25"></span>
<span id="cb4-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> results_path.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"w"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb4-27">            f.write(json.dumps(results))</span>
<span id="cb4-28"></span>
<span id="cb4-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> results</span></code></pre></div>
</details>
</div>
<div id="3ae984ed-297a-400b-944a-2b27b9038953" class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">gp_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_dataset(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gp"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2023</span>)</span>
<span id="cb5-2">quali_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_dataset(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quali"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2023</span>)</span></code></pre></div>
</div>
<p>Next, we unnest it into a row-wise format and load it as a Pandas dataframe for ease of use:</p>
<div id="5713c8b1-22a6-4baf-ae55-9791515dce97" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> gp_results_to_dataframe(json_data):</span>
<span id="cb6-2">    data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb6-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> gp <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> json_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MRData"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RaceTable"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Races"</span>]:</span>
<span id="cb6-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> result <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> gp[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Results"</span>]:</span>
<span id="cb6-5">            data.setdefault(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuit"</span>, []).append(gp[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Circuit"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuitId"</span>])</span>
<span id="cb6-6">            data.setdefault(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>, []).append(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Driver"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"code"</span>])</span>
<span id="cb6-7">            data.setdefault(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"round"</span>, []).append(gp[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"round"</span>])</span>
<span id="cb6-8">            data.setdefault(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>, []).append(</span>
<span id="cb6-9">                result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Constructor"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructorId"</span>]</span>
<span id="cb6-10">            )</span>
<span id="cb6-11"></span>
<span id="cb6-12">            data.setdefault(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grid"</span>, []).append(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grid"</span>])</span>
<span id="cb6-13">            data.setdefault(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>, []).append(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>])</span>
<span id="cb6-14">            data.setdefault(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"points"</span>, []).append(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"points"</span>])</span>
<span id="cb6-15">            data.setdefault(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fastest_lap"</span>, []).append(</span>
<span id="cb6-16">                result.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FastestLap"</span>, {}).get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rank"</span>)</span>
<span id="cb6-17">            )</span>
<span id="cb6-18">            data.setdefault(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"status"</span>, []).append(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"status"</span>])</span>
<span id="cb6-19"></span>
<span id="cb6-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (</span>
<span id="cb6-21">        pd.DataFrame(data)</span>
<span id="cb6-22">        .astype(</span>
<span id="cb6-23">            {</span>
<span id="cb6-24">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuit"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>,</span>
<span id="cb6-25">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>,</span>
<span id="cb6-26">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"round"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"int"</span>,</span>
<span id="cb6-27">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>,</span>
<span id="cb6-28">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"status"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>,</span>
<span id="cb6-29">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grid"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Int64"</span>,</span>
<span id="cb6-30">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Int64"</span>,</span>
<span id="cb6-31">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"points"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float32"</span>,</span>
<span id="cb6-32">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fastest_lap"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Int64"</span>,</span>
<span id="cb6-33">            }</span>
<span id="cb6-34">        )</span>
<span id="cb6-35">        .set_index([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuit"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>])</span>
<span id="cb6-36">    )</span>
<span id="cb6-37"></span>
<span id="cb6-38"></span>
<span id="cb6-39"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> quali_results_to_dataframe(json_data):</span>
<span id="cb6-40">    data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb6-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> quali <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> json_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MRData"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RaceTable"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Races"</span>]:</span>
<span id="cb6-42">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> result <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> quali[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"QualifyingResults"</span>]:</span>
<span id="cb6-43">            data.setdefault(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuit"</span>, []).append(quali[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Circuit"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuitId"</span>])</span>
<span id="cb6-44">            data.setdefault(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>, []).append(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Driver"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"code"</span>])</span>
<span id="cb6-45">            data.setdefault(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"round"</span>, []).append(quali[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"round"</span>])</span>
<span id="cb6-46">            data.setdefault(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>, []).append(</span>
<span id="cb6-47">                result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Constructor"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructorId"</span>]</span>
<span id="cb6-48">            )</span>
<span id="cb6-49"></span>
<span id="cb6-50">            data.setdefault(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qualifying_position"</span>, []).append(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>])</span>
<span id="cb6-51"></span>
<span id="cb6-52">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (</span>
<span id="cb6-53">        pd.DataFrame(data)</span>
<span id="cb6-54">        .astype(</span>
<span id="cb6-55">            {</span>
<span id="cb6-56">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuit"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>,</span>
<span id="cb6-57">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>,</span>
<span id="cb6-58">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"round"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"int"</span>,</span>
<span id="cb6-59">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>,</span>
<span id="cb6-60">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qualifying_position"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Int64"</span>,</span>
<span id="cb6-61">            }</span>
<span id="cb6-62">        )</span>
<span id="cb6-63">        .set_index([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuit"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>])</span>
<span id="cb6-64">    )</span></code></pre></div>
</details>
</div>
<div id="5de8cadd-8494-4211-b405-cc36346375aa" class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">gp_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gp_results_to_dataframe(gp_data)</span>
<span id="cb7-2">gp_df</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">round</th>
<th data-quarto-table-cell-role="th">constructor</th>
<th data-quarto-table-cell-role="th">grid</th>
<th data-quarto-table-cell-role="th">position</th>
<th data-quarto-table-cell-role="th">points</th>
<th data-quarto-table-cell-role="th">fastest_lap</th>
<th data-quarto-table-cell-role="th">status</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">circuit</th>
<th data-quarto-table-cell-role="th">driver</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">bahrain</td>
<td data-quarto-table-cell-role="th">VER</td>
<td>1</td>
<td>red_bull</td>
<td>1</td>
<td>1</td>
<td>25.0</td>
<td>6</td>
<td>Finished</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PER</td>
<td>1</td>
<td>red_bull</td>
<td>2</td>
<td>2</td>
<td>18.0</td>
<td>7</td>
<td>Finished</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ALO</td>
<td>1</td>
<td>aston_martin</td>
<td>5</td>
<td>3</td>
<td>15.0</td>
<td>5</td>
<td>Finished</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">SAI</td>
<td>1</td>
<td>ferrari</td>
<td>4</td>
<td>4</td>
<td>12.0</td>
<td>14</td>
<td>Finished</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">HAM</td>
<td>1</td>
<td>mercedes</td>
<td>7</td>
<td>5</td>
<td>10.0</td>
<td>10</td>
<td>Finished</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">monza</td>
<td data-quarto-table-cell-role="th">STR</td>
<td>14</td>
<td>aston_martin</td>
<td>20</td>
<td>16</td>
<td>0.0</td>
<td>17</td>
<td>Finished</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">HUL</td>
<td>14</td>
<td>haas</td>
<td>13</td>
<td>17</td>
<td>0.0</td>
<td>10</td>
<td>+1 Lap</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">MAG</td>
<td>14</td>
<td>haas</td>
<td>19</td>
<td>18</td>
<td>0.0</td>
<td>15</td>
<td>+1 Lap</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">OCO</td>
<td>14</td>
<td>alpine</td>
<td>18</td>
<td>19</td>
<td>0.0</td>
<td>19</td>
<td>Steering</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">TSU</td>
<td>14</td>
<td>alphatauri</td>
<td>11</td>
<td>20</td>
<td>0.0</td>
<td>&lt;NA&gt;</td>
<td>Engine</td>
</tr>
</tbody>
</table>

<p>280 rows × 7 columns</p>
</div>
</div>
</div>
</div>
<div id="eb2865ed-2cff-4dd9-a10b-93b7e6e90c39" class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">quali_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> quali_results_to_dataframe(quali_data)</span>
<span id="cb8-2">quali_df</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">round</th>
<th data-quarto-table-cell-role="th">constructor</th>
<th data-quarto-table-cell-role="th">qualifying_position</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">circuit</th>
<th data-quarto-table-cell-role="th">driver</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">bahrain</td>
<td data-quarto-table-cell-role="th">VER</td>
<td>1</td>
<td>red_bull</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PER</td>
<td>1</td>
<td>red_bull</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">LEC</td>
<td>1</td>
<td>ferrari</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">SAI</td>
<td>1</td>
<td>ferrari</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ALO</td>
<td>1</td>
<td>aston_martin</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">monza</td>
<td data-quarto-table-cell-role="th">ZHO</td>
<td>14</td>
<td>alfa</td>
<td>16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">GAS</td>
<td>14</td>
<td>alpine</td>
<td>17</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">OCO</td>
<td>14</td>
<td>alpine</td>
<td>18</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">MAG</td>
<td>14</td>
<td>haas</td>
<td>19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">STR</td>
<td>14</td>
<td>aston_martin</td>
<td>20</td>
</tr>
</tbody>
</table>

<p>280 rows × 3 columns</p>
</div>
</div>
</div>
</div>
<p>Finally, we join the grand prix and qualifying dataframes together, forming the base dataset for our analysis; we also rename all entries credited to Liam Lawson (LAW) to Daniel Ricciardio (RIC), as Fantasy GP credits points from the temporary reserve driver to the driver they replace:</p>
<div id="25a5d343-64c0-4d69-87c9-73dff02e0791" class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">data_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gp_df.join(quali_df[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qualifying_position"</span>]]).rename(</span>
<span id="cb9-2">    level<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LAW"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RIC"</span>}</span>
<span id="cb9-3">)</span>
<span id="cb9-4">data_df</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">round</th>
<th data-quarto-table-cell-role="th">constructor</th>
<th data-quarto-table-cell-role="th">grid</th>
<th data-quarto-table-cell-role="th">position</th>
<th data-quarto-table-cell-role="th">points</th>
<th data-quarto-table-cell-role="th">fastest_lap</th>
<th data-quarto-table-cell-role="th">status</th>
<th data-quarto-table-cell-role="th">qualifying_position</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">circuit</th>
<th data-quarto-table-cell-role="th">driver</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">bahrain</td>
<td data-quarto-table-cell-role="th">VER</td>
<td>1</td>
<td>red_bull</td>
<td>1</td>
<td>1</td>
<td>25.0</td>
<td>6</td>
<td>Finished</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PER</td>
<td>1</td>
<td>red_bull</td>
<td>2</td>
<td>2</td>
<td>18.0</td>
<td>7</td>
<td>Finished</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ALO</td>
<td>1</td>
<td>aston_martin</td>
<td>5</td>
<td>3</td>
<td>15.0</td>
<td>5</td>
<td>Finished</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">SAI</td>
<td>1</td>
<td>ferrari</td>
<td>4</td>
<td>4</td>
<td>12.0</td>
<td>14</td>
<td>Finished</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">HAM</td>
<td>1</td>
<td>mercedes</td>
<td>7</td>
<td>5</td>
<td>10.0</td>
<td>10</td>
<td>Finished</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">monza</td>
<td data-quarto-table-cell-role="th">STR</td>
<td>14</td>
<td>aston_martin</td>
<td>20</td>
<td>16</td>
<td>0.0</td>
<td>17</td>
<td>Finished</td>
<td>20</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">HUL</td>
<td>14</td>
<td>haas</td>
<td>13</td>
<td>17</td>
<td>0.0</td>
<td>10</td>
<td>+1 Lap</td>
<td>13</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">MAG</td>
<td>14</td>
<td>haas</td>
<td>19</td>
<td>18</td>
<td>0.0</td>
<td>15</td>
<td>+1 Lap</td>
<td>19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">OCO</td>
<td>14</td>
<td>alpine</td>
<td>18</td>
<td>19</td>
<td>0.0</td>
<td>19</td>
<td>Steering</td>
<td>18</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">TSU</td>
<td>14</td>
<td>alphatauri</td>
<td>11</td>
<td>20</td>
<td>0.0</td>
<td>&lt;NA&gt;</td>
<td>Engine</td>
<td>11</td>
</tr>
</tbody>
</table>

<p>280 rows × 8 columns</p>
</div>
</div>
</div>
</div>
</section>
<section id="fantasy-points" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="fantasy-points"><span class="header-section-number">1.2</span> Fantasy points</h2>
<p>Fantasy GP points per team/driver are <a href="https://fantasygp.com/about/guide/">calculated in the following way</a>:</p>
<ul>
<li>drivers earn the points scored during the grand prix, 10pts for taking pole position, 2pts per position gained on Sunday, and 5 points each for beating their teammate during qualifying and the race itself.</li>
<li>constructors earn the points scored by each of their drivers during the grand prix, 1pt per position gained per driver, 5 points if both cars finish, 2 if only one car finishes.</li>
</ul>
<p>To simplify the problem, we completely ignore sprint races (as should everyone).</p>
<p>The race finish status classification has several detailed categories:</p>
<div id="e0f66f62-f8c8-4d68-a172-8ab8515a759c" class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">data_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"status"</span>].dtype</span></code></pre></div>
<div class="cell-output cell-output-display">
<pre><code>CategoricalDtype(categories=['+1 Lap', '+2 Laps', 'Accident', 'Brakes', 'Collision',
                  'Collision damage', 'Electrical', 'Engine', 'Finished',
                  'Mechanical', 'Oil leak', 'Overheating', 'Power loss',
                  'Retired', 'Steering', 'Undertray'],
, ordered=False, categories_dtype=object)</code></pre>
</div>
</div>
<p>Fantasy GP scoring only cares whether a car finished or not, so we define the following set of categories to indiciate a finish:</p>
<div id="ea99e41d-d5fe-4a26-bde7-856c4f54e256" class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">STATUS_FINISHED <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Finished"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"+1 Lap"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"+2 Laps"</span>]</span></code></pre></div>
</div>
<p>While our dataset has the WDC points scored per driver/constructor already, positions gained and performance vs.&nbsp;teammate need to be added in:</p>
<div id="b2acaa5d-151b-4a75-87ad-86f28f8c73c2" class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> add_scoring_cols(df: pd.DataFrame) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> pd.DataFrame:</span>
<span id="cb13-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> df.assign(</span>
<span id="cb13-3">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Grid value of 0 indicates pit lane start; here we set that to 99</span></span>
<span id="cb13-4">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to simplify the check for who won out in qualifying.</span></span>
<span id="cb13-5">        grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grid"</span>].where(x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grid"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span>
<span id="cb13-6">    ).assign(</span>
<span id="cb13-7">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Positions gained compared to the starting grid position; scoring doesn't</span></span>
<span id="cb13-8">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># care about positions lost, so we set anything below 0 to 0.</span></span>
<span id="cb13-9">        positions_gained<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: np.maximum(x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grid"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb13-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Whether the driver won pole position</span></span>
<span id="cb13-11">        has_pole<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qualifying_position"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb13-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Whether the driver beat their teammate in qualifying</span></span>
<span id="cb13-13">        beat_teammate_quali<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: x.groupby(</span>
<span id="cb13-14">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Each group is per race, per constructor, so only 2 rows - one for each driver.</span></span>
<span id="cb13-15">            [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuit"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>],</span>
<span id="cb13-16">            group_keys<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb13-17">        ).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(</span>
<span id="cb13-18">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Smaller grid pos. = better; the grid position is compared</span></span>
<span id="cb13-19">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to the reversed grid array in the group (essentially</span></span>
<span id="cb13-20">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># we create a cartesian product of the grid pos.)</span></span>
<span id="cb13-21">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> g: g[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grid"</span>]</span>
<span id="cb13-22">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> g[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grid"</span>].iloc[::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].values</span>
<span id="cb13-23">        ),</span>
<span id="cb13-24">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Same as the previous column, but for finishing position in the race.</span></span>
<span id="cb13-25">        beat_teammate_race<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: x.groupby(</span>
<span id="cb13-26">            [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuit"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>], group_keys<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb13-27">        ).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(</span>
<span id="cb13-28">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> g: (g[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> g[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"position"</span>].iloc[::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].values)</span>
<span id="cb13-29">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> g[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"status"</span>].isin(STATUS_FINISHED)</span>
<span id="cb13-30">        ),</span>
<span id="cb13-31">        has_fastest_lap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fastest_lap"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb13-32">    )</span>
<span id="cb13-33"></span>
<span id="cb13-34"></span>
<span id="cb13-35">data_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> add_scoring_cols(data_df)</span></code></pre></div>
</div>
<p>This leaves us with the following dataframe:</p>
<div id="416d15a4-d6df-4852-914d-cdd246fcac6d" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">data_df[</span>
<span id="cb14-2">    [</span>
<span id="cb14-3">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grid"</span>,</span>
<span id="cb14-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"positions_gained"</span>,</span>
<span id="cb14-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beat_teammate_quali"</span>,</span>
<span id="cb14-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beat_teammate_race"</span>,</span>
<span id="cb14-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"has_pole"</span>,</span>
<span id="cb14-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"has_fastest_lap"</span>,</span>
<span id="cb14-9">    ]</span>
<span id="cb14-10">]</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">grid</th>
<th data-quarto-table-cell-role="th">positions_gained</th>
<th data-quarto-table-cell-role="th">beat_teammate_quali</th>
<th data-quarto-table-cell-role="th">beat_teammate_race</th>
<th data-quarto-table-cell-role="th">has_pole</th>
<th data-quarto-table-cell-role="th">has_fastest_lap</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">circuit</th>
<th data-quarto-table-cell-role="th">driver</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">bahrain</td>
<td data-quarto-table-cell-role="th">VER</td>
<td>1</td>
<td>0</td>
<td>True</td>
<td>True</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PER</td>
<td>2</td>
<td>0</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ALO</td>
<td>5</td>
<td>2</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">SAI</td>
<td>4</td>
<td>0</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">HAM</td>
<td>7</td>
<td>2</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">monza</td>
<td data-quarto-table-cell-role="th">STR</td>
<td>20</td>
<td>4</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">HUL</td>
<td>13</td>
<td>0</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">MAG</td>
<td>19</td>
<td>1</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">OCO</td>
<td>18</td>
<td>0</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">TSU</td>
<td>11</td>
<td>0</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>&lt;NA&gt;</td>
</tr>
</tbody>
</table>

<p>280 rows × 6 columns</p>
</div>
</div>
</div>
</div>
<p>Finally, we can score the Fantasy GP points; we define the scoring function for the driver to be the sum of:</p>
<ul>
<li>WDC points</li>
<li>10 for gaining pole position</li>
<li>5 for outqualifying their teammate</li>
<li>5 for outracing their teammate</li>
<li>2 per position gained at the end of the race</li>
</ul>
<p>Note that a driver who did not finish the race on Sunday can still earn points from the qualifying session.</p>
<div id="1ab83315-fec2-484d-9c8f-f108172f1c02" class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> score_driver(x):</span>
<span id="cb15-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> pd.Series(</span>
<span id="cb15-3">        x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"has_pole"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beat_teammate_quali"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span></span>
<span id="cb15-4">    ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> pd.Series(</span>
<span id="cb15-5">        x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"points"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"positions_gained"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beat_teammate_race"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb15-6">        dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>,</span>
<span id="cb15-7">    ).where(</span>
<span id="cb15-8">        x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"status"</span>].isin(STATUS_FINISHED), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb15-9">    )</span></code></pre></div>
</div>
<p>Scoring for the constructors is defined as:</p>
<ul>
<li>WDC points</li>
<li>5 points if both cars finished, 2 if only one did</li>
<li>1 point per position gained at the end of the race per car</li>
</ul>
<div id="27c01794-fd9f-478c-acc7-496e62044295" class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> score_constructor(x):</span>
<span id="cb16-2">    finished <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"status"</span>].isin(STATUS_FINISHED)</span>
<span id="cb16-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">match</span> finished.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>():</span>
<span id="cb16-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">case</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:</span>
<span id="cb16-5">            finish_bonus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb16-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">case</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb16-7">            finish_bonus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb16-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">case</span> _:</span>
<span id="cb16-9">            finish_bonus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb16-10"></span>
<span id="cb16-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"points"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x[finished][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"positions_gained"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> finish_bonus</span></code></pre></div>
</div>
<p>Just from the rules definition it is clear that drivers have a higher points earnign ceiling but much higher variance, whereas constructors are more consistent but earn fewer points.</p>
<div id="b2a56557-1733-4346-b888-288543b4e375" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> score_fantasy_points(df: pd.DataFrame) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> pd.DataFrame:</span>
<span id="cb17-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> df.assign(</span>
<span id="cb17-3">        driver_points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>score_driver,</span>
<span id="cb17-4">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Constructor points need to be joined back in on the grouping columns, in order to</span></span>
<span id="cb17-5">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fill in the missing spots with duplicate values - since we have 20 drivers, but 10 constructors,</span></span>
<span id="cb17-6">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the group has fewer rows and needs to be broadcast per group on the index.</span></span>
<span id="cb17-7">        constructor_points<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: x.join(</span>
<span id="cb17-8">            x.groupby([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuit"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>])</span>
<span id="cb17-9">            .<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(score_constructor)</span>
<span id="cb17-10">            .rename(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor_points"</span>),</span>
<span id="cb17-11">            on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuit"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>],</span>
<span id="cb17-12">        )[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor_points"</span>],</span>
<span id="cb17-13">    )</span></code></pre></div>
</details>
</div>
<p>The scored dataframe looks like this:</p>
<div id="a1ecc81b-1e0c-4949-9eac-4056687fb096" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">data_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> score_fantasy_points(data_df)</span>
<span id="cb18-2">data_df[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver_points"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor_points"</span>]]</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">driver_points</th>
<th data-quarto-table-cell-role="th">constructor_points</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">circuit</th>
<th data-quarto-table-cell-role="th">driver</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">bahrain</td>
<td data-quarto-table-cell-role="th">VER</td>
<td>45.0</td>
<td>48.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PER</td>
<td>18.0</td>
<td>48.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ALO</td>
<td>29.0</td>
<td>32.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">SAI</td>
<td>17.0</td>
<td>14.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">HAM</td>
<td>19.0</td>
<td>23.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">monza</td>
<td data-quarto-table-cell-role="th">STR</td>
<td>8.0</td>
<td>12.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">HUL</td>
<td>10.0</td>
<td>6.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">MAG</td>
<td>2.0</td>
<td>6.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">OCO</td>
<td>0.0</td>
<td>4.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">TSU</td>
<td>5.0</td>
<td>3.0</td>
</tr>
</tbody>
</table>

<p>280 rows × 2 columns</p>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The constructor points are duplicated per race, since we broadcast those across both drivers.</p>
</div>
</div>
</section>
<section id="data-exploration" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="data-exploration"><span class="header-section-number">1.3</span> Data exploration</h2>
<p>Now we visualize the data to get a better idea of its properties. First, some basic box plots for each driver/constructor:</p>
<div id="cell-fig-driver-points" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">sns.set_theme(style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ticks"</span>)</span>
<span id="cb19-2">f, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span>
<span id="cb19-3">sns.boxplot(</span>
<span id="cb19-4">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>data_df.reset_index(),</span>
<span id="cb19-5">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver_points"</span>,</span>
<span id="cb19-6">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>,</span>
<span id="cb19-7">    palette<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pastel"</span>,</span>
<span id="cb19-8">    whis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>],</span>
<span id="cb19-9">)</span>
<span id="cb19-10"></span>
<span id="cb19-11">sns.stripplot(</span>
<span id="cb19-12">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver_points"</span>,</span>
<span id="cb19-13">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>,</span>
<span id="cb19-14">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>data_df.reset_index(),</span>
<span id="cb19-15">    hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuit"</span>,</span>
<span id="cb19-16">    linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb19-17">    size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb19-18">    dodge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb19-19">    palette<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"muted"</span>,</span>
<span id="cb19-20">)</span>
<span id="cb19-21"></span>
<span id="cb19-22">ax.xaxis.grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb19-23">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"points"</span>)</span>
<span id="cb19-24">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Driver Fantasy GP points 2023"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-driver-points" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-driver-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-driver-points-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-driver-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Fantasy points earned by each driver in 2023
</figcaption>
</figure>
</div>
</div>
</div>
<p>For convenience, we create a constructor-specific dataframe by taking the first row for each constructor for each race. This gets rid of the duplicate data (as constructor points were duplicated across both drivers):</p>
<div id="e9969bc2-6af1-45f3-9c68-4670505efe17" class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">const_data_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data_df.groupby([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuit"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>]).first().reset_index()</span></code></pre></div>
</div>
<div id="cell-fig-constructor-points" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">sns.set_theme(style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ticks"</span>)</span>
<span id="cb21-2">f, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb21-3">sns.boxplot(</span>
<span id="cb21-4">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>const_data_df.reset_index(),</span>
<span id="cb21-5">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor_points"</span>,</span>
<span id="cb21-6">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>,</span>
<span id="cb21-7">    palette<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pastel"</span>,</span>
<span id="cb21-8">    whis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>],</span>
<span id="cb21-9">)</span>
<span id="cb21-10"></span>
<span id="cb21-11">sns.stripplot(</span>
<span id="cb21-12">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor_points"</span>,</span>
<span id="cb21-13">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>,</span>
<span id="cb21-14">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>const_data_df.reset_index(),</span>
<span id="cb21-15">    hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuit"</span>,</span>
<span id="cb21-16">    palette<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"muted"</span>,</span>
<span id="cb21-17">    linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb21-18">    size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb21-19">    dodge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb21-20">)</span>
<span id="cb21-21"></span>
<span id="cb21-22">ax.xaxis.grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb21-23">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"points"</span>)</span>
<span id="cb21-24">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Constructor Fantasy GP points 2023"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-constructor-points" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-constructor-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-constructor-points-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-constructor-points-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Fantasy points earned by each constructor in 2023
</figcaption>
</figure>
</div>
</div>
</div>
<p>These look quite similar and expose the brutal reality of Red Bull’s total dominance over the field. Matching our intuition from the rules definition, drivers appear to earn more and have wider variance in points scored, comapred to teams, with the exception of Max Verstappen and his absurd consistency.</p>
<p>Next, we plot the kernel density estimate of the driver points to gain a better idea of the overall distribution:</p>
<div id="cell-fig-driver-points-kde" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.displot(</span>
<span id="cb22-2">    data_df.reset_index(),</span>
<span id="cb22-3">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver_points"</span>,</span>
<span id="cb22-4">    col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>,</span>
<span id="cb22-5">    kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kde"</span>,</span>
<span id="cb22-6">    rug<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb22-7">    col_wrap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb22-8">    fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb22-9">)</span>
<span id="cb22-10">g.set_axis_labels(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"points"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"density"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-driver-points-kde" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-driver-points-kde-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-driver-points-kde-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-driver-points-kde-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Kernel density estimates for fantasy points earned by each driver in 2023
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-constructor-points-kde" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.displot(</span>
<span id="cb23-2">    const_data_df.reset_index(),</span>
<span id="cb23-3">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor_points"</span>,</span>
<span id="cb23-4">    col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>,</span>
<span id="cb23-5">    col_wrap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb23-6">    kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kde"</span>,</span>
<span id="cb23-7">    height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb23-8">    rug<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb23-9">    fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb23-10">)</span>
<span id="cb23-11"></span>
<span id="cb23-12"></span>
<span id="cb23-13">g.set_axis_labels(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"points"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"density"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-constructor-points-kde" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-constructor-points-kde-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-constructor-points-kde-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-constructor-points-kde-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Kernel density estimates for fantasy points earned by each constructor in 2023
</figcaption>
</figure>
</div>
</div>
</div>
<p>The distribution of points is spread and somewhat multi-peaked in both cases; again, constructors appear score in a much more consistent range compared to drivers. The pooled observed points distributions are:</p>
<div id="cell-fig-grouped-points-kde" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">f, axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), sharey<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb24-2"></span>
<span id="cb24-3">sns.kdeplot(data_df.reset_index(), x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver_points"</span>, fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb24-4">sns.kdeplot(const_data_df.reset_index(), x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor_points"</span>, fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb24-5">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overall driver points density 2023"</span>)</span>
<span id="cb24-6">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver points"</span>)</span>
<span id="cb24-7"></span>
<span id="cb24-8">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overall constructor points density 2023"</span>)</span>
<span id="cb24-9">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor points"</span>)</span>
<span id="cb24-10"></span>
<span id="cb24-11">f.tight_layout()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-grouped-points-kde" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-grouped-points-kde-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-grouped-points-kde-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-grouped-points-kde-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Grouped kernel density estimates for fantasy points by drivers/constructors in 2023
</figcaption>
</figure>
</div>
</div>
</div>
<p>Given that the point distributions between drivers and constructors appear very similar, we’ll focus on constructing models of the driver points, which we can later fit to the constructor data with minor adjustments.</p>
</section>
<section id="unpooled-model" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="unpooled-model"><span class="header-section-number">1.4</span> Unpooled model</h2>
<p>Our first model will be the simplest possible - we just directly estimate the mean points for each driver individually (an intercept-only, unpooled linear model).</p>
<section id="picking-the-likelihood" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="picking-the-likelihood"><span class="header-section-number">1.4.1</span> Picking the likelihood</h3>
<p>The points data has several properties that stem from the Fantasy GP ruleset:</p>
<ul>
<li>points are discrete</li>
<li>points are strictly bound between 0 and 84 (25 for p1 + 1 for fastest lap + 10 for pole position + 10 for beating teammate + 19 * 2 for maximum possible positions gained)</li>
<li>most drivers have a few 0 point finishes, but overall it’s very unlikely for a driver to score 0 points consistently.</li>
</ul>
<p>Because we are modeling discrete, strictly positive points, one of the count distributions is likely an appropriate choice for the likelihood. The <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.Poisson.html">Poisson</a> distribution could be a good choice, but the observations appear overdispersed, as measured by the <a href="https://en.wikipedia.org/wiki/Index_of_dispersion">coefficient of dispersion</a>:</p>
<div id="42ee4305-73b5-4af3-a44d-29b77850e998" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">data_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data_df.reset_index().astype(</span>
<span id="cb25-2">    {</span>
<span id="cb25-3">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circuit"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>,</span>
<span id="cb25-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>,</span>
<span id="cb25-5">    }</span>
<span id="cb25-6">)</span>
<span id="cb25-7"></span>
<span id="cb25-8">dispersion <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb25-9">    data_df.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver_points"</span>].var()</span>
<span id="cb25-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> data_df.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver_points"</span>].mean()</span>
<span id="cb25-11">)</span>
<span id="cb25-12">dispersion</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>driver
ALB     2.016575
ALO     2.458689
BOT     4.663685
DEV     2.808279
GAS    12.389453
HAM     2.238189
HUL     3.298566
LEC     8.306281
MAG     4.909699
NOR     5.876923
OCO     7.848030
PER     3.748745
PIA     6.062937
RIC     2.466667
RUS     5.968760
SAI     6.063976
SAR     6.434705
STR     5.173077
TSU     2.345168
VER     1.030361
ZHO     7.205955
Name: driver_points, dtype: float64</code></pre>
</div>
</div>
<p>Given that, we will pick the <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.NegativeBinomial.html">Negative Binomial</a> as our likelihood, since it handles overdispersion better<sup>1</sup>.</p>
</section>
<section id="choosing-the-priors" class="level3" data-number="1.4.2">
<h3 data-number="1.4.2" class="anchored" data-anchor-id="choosing-the-priors"><span class="header-section-number">1.4.2</span> Choosing the priors</h3>
<p>A <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.NegativeBinomial.html">Negative Binomial</a> likelihood is defined by two parameters - its mean μ, and a shape parameter α. We’ll need to set priors on both.</p>
<p>The mean is restricted to be positive only. The standard way of defining a negative binomial linear model is to set a Normal prior on the mean and use the exponentiation as the inverse link function to make it positive and usable for parameterizing the likelihood. For the actual prior parameters it would be reasonable to go with a fairly uninformative prior, such as <code>Normal(mu=0, sigma=1)</code>; in this case, prior knowledge and the ruleset gives us a hunch that we can reasonably expect most drivers’ mean points per race to be somewhere between 5 (backmarker, occasionally beats their teammate, maybe gains a place) and 30 (top driver &amp; team, consistently getting and winning from pole position).</p>
<p>To come up with parameter values for this, we use the <a href="https://preliz.readthedocs.io/en/latest/">PreliZ</a> library to find a maximum entropy <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.Normal.html">Normal</a> distribution with 90% of its mass between 5 and 30 (we take the natural log of those, given the exponential inverse link):</p>
<div id="cell-fig-mu-prior" class="cell">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">mu_dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pz.Normal()</span>
<span id="cb27-2">pz.maxent(mu_dist, np.log(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), np.log(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.90</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-mu-prior" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mu-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-mu-prior-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mu-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: PDF of the prior chosen for μ
</figcaption>
</figure>
</div>
</div>
</div>
<p>The shape parameter α is also strictly positive. Its effect on the likelihood can be best understood by plotting a <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.NegativeBinomial.html">Negative Binomial</a> for a few different values, while keeping the mean fixed:</p>
<div id="cell-fig-nb-shape" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">f, axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>), sharey<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb28-2"></span>
<span id="cb28-3">pz.NegativeBinomial(alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, mu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>).plot_pdf(ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], legend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb28-4">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Negative Binomial with μ: 15, α: 0.5"</span>)</span>
<span id="cb28-5"></span>
<span id="cb28-6">pz.NegativeBinomial(alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, mu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>).plot_pdf(ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], legend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb28-7">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Negative Binomial with μ: 15, α: 5"</span>)</span>
<span id="cb28-8"></span>
<span id="cb28-9">pz.NegativeBinomial(alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, mu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>).plot_pdf(ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], legend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb28-10">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Negative Binomial with μ: 15, α: 50"</span>)</span>
<span id="cb28-11"></span>
<span id="cb28-12">pz.NegativeBinomial(alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>, mu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>).plot_pdf(ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], legend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb28-13">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Negative Binomial with μ: 15, α: 500"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-nb-shape" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nb-shape-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-nb-shape-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nb-shape-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Negative binomial distributions with a fixed mean at different shape parameters
</figcaption>
</figure>
</div>
</div>
</div>
<p>As α increases, the tails shrink. We don’t want very high values, as that will restrict the tails too much, but very small values result in absurdly long tails. To handle that, we use a <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.Gamma.html">Gamma</a> distribution, with mass strongly concentrated between 1 and 20:</p>
<div id="cell-fig-alpha-prior" class="cell">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">alpha_dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pz.Gamma()</span>
<span id="cb29-2">pz.maxent(alpha_dist, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-alpha-prior" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-alpha-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-alpha-prior-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-alpha-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: PDF of the prior chosen for α
</figcaption>
</figure>
</div>
</div>
</div>
<p>Finally, we prepare the data for use within the model. We factorize the <code>driver</code> column into labels and an index:</p>
<div id="349ca646-0714-4338-8613-c4ac870344e7" class="cell">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">idx, labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.factorize(data_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>], sort<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
</div>
<p><code>labels</code> is a categorical variable over the driver names:</p>
<div id="f23862b3-e0f7-437b-8ba9-60af46f10a99" class="cell">
<div class="cell-output cell-output-display">
<pre><code>CategoricalIndex(['ALB', 'ALO', 'BOT', 'DEV', 'GAS', 'HAM', 'HUL', 'LEC',
                  'MAG', 'NOR', 'OCO', 'PER', 'PIA', 'RIC', 'RUS', 'SAI',
                  'SAR', 'STR', 'TSU', 'VER', 'ZHO'],
                 categories=['ALB', 'ALO', 'BOT', 'DEV', ..., 'STR', 'TSU', 'VER', 'ZHO'], ordered=False, dtype='category')</code></pre>
</div>
</div>
<p><code>idx</code> is the flattened (race number, driver) index into the observed race result rows:</p>
<div id="8d421513-9417-41d4-a222-42b0858a3d4f" class="cell">
<div class="cell-output cell-output-display">
<pre><code>array([19, 11,  1, 15,  5, 17, 14,  2,  4,  0, 18, 16,  8,  3,  6, 20,  9,
       10,  7, 12, 11, 19,  1, 14,  5, 15,  7, 10,  4,  8, 18,  6, 20,  3,
       12, 16,  9,  2,  0, 17, 19,  5,  1, 17, 11,  9,  6, 12, 20, 18,  2,
       15,  4, 10,  3, 16,  8, 14,  0,  7, 11, 19,  7,  1, 15,  5, 17, 14,
        9, 18, 12,  0,  8,  4, 10, 16,  6,  2, 20,  3, 19, 11,  1, 14, 15,
        5,  7,  4, 10,  8, 18, 17,  2,  0,  6, 20,  9,  3, 12, 16, 19,  1,
       10,  5, 14,  7,  4, 15,  9, 12,  2,  3, 20,  0, 18, 11,  6, 16,  8,
       17, 19,  5, 14, 11, 15, 17,  1, 10, 20,  4,  7, 18, 12,  3,  6,  0,
        9,  8,  2, 16, 19,  1,  5,  7, 15, 11,  0, 10, 17,  2, 12,  4,  9,
       18,  6, 20,  8,  3, 14, 16, 19,  7, 11,  9,  1, 15, 14,  5, 17,  4,
        0, 20, 16, 10,  2, 12,  3,  8, 18,  6, 19,  9,  5, 12, 14, 11,  1,
        0,  7, 15, 16,  2,  6, 17, 20, 18,  3,  4,  8, 10, 19,  9, 11,  5,
       12, 14,  7, 15,  1, 17,  0,  2, 13,  6, 18, 20,  8, 16, 10,  4, 19,
       11,  7,  5,  1, 14,  9, 10, 17, 18,  4,  2, 20,  0,  8, 13, 16,  6,
       15, 12, 19,  1,  4, 11, 15,  5,  9,  0, 12, 10, 17,  6, 13,  2, 18,
        8, 14, 20,  7, 16, 19, 11, 15,  7, 14,  5,  0,  9,  1,  2, 13, 12,
       16, 20,  4, 17,  6,  8, 10, 18])</code></pre>
</div>
</div>
<p>We also extract the observed points:</p>
<div id="eb0cc275-0ef0-40b1-aba1-66303e1de1ee" class="cell">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1">driver_points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver_points"</span>]</span>
<span id="cb33-2">driver_points</span></code></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0      45.0
1      18.0
2      29.0
3      17.0
4      19.0
       ... 
275     8.0
276    10.0
277     2.0
278     0.0
279     5.0
Name: driver_points, Length: 280, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="model-definition" class="level3" data-number="1.4.3">
<h3 data-number="1.4.3" class="anchored" data-anchor-id="model-definition"><span class="header-section-number">1.4.3</span> Model definition</h3>
<p>Next, we define the model with <a href="https://www.pymc.io/">PyMC</a>. As discussed previously, we think that the process that generates points can be seen as a Negative Binomial distribution, so that is set as the likelihood. The mean (μ) аnd shape (α) are the parameters that we want to infer from the data. Finally, the prior guesses for these parameters are set from the <code>mu_dist</code> and <code>alpha_dist</code> objects we computed previously.</p>
<p>This translates to:</p>
<div id="02920709-0edb-4f55-a500-22a7ea3cb7cf" class="cell">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> pm.Model(coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>: labels, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idx"</span>: idx}) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> unpooled_negb:</span>
<span id="cb35-2">    μ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Normal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ"</span>, mu_dist.mu, mu_dist.sigma, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>)</span>
<span id="cb35-3">    μ_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ_"</span>, pm.math.exp(μ), dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>)</span>
<span id="cb35-4"></span>
<span id="cb35-5">    α <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Gamma(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"α"</span>, alpha_dist.alpha, alpha_dist.beta, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>)</span>
<span id="cb35-6"></span>
<span id="cb35-7">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.NegativeBinomial(</span>
<span id="cb35-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>α[idx], mu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>μ_[idx], observed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>driver_points, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idx"</span></span>
<span id="cb35-9">    )</span></code></pre></div>
</div>
</section>
<section id="prior-predictive-checks" class="level3" data-number="1.4.4">
<h3 data-number="1.4.4" class="anchored" data-anchor-id="prior-predictive-checks"><span class="header-section-number">1.4.4</span> Prior predictive checks</h3>
<p>To see if the choice for priors is acceptable, we sample from the prior predictive and plot the results:</p>
<div id="ed158fc1-3308-4467-b16a-8e37c18b2272" class="cell">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> unpooled_negb:</span>
<span id="cb36-2">    unpooled_prior_samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.sample_prior_predictive(samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [y, α, μ]</code></pre>
</div>
</div>
<div id="cell-fig-unpooled-prior-predictive" class="cell">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">az.plot_ppc(unpooled_prior_samples, group<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prior"</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-unpooled-prior-predictive" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-unpooled-prior-predictive-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-unpooled-prior-predictive-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-unpooled-prior-predictive-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Prior predictive distribution of the unpooled model
</figcaption>
</figure>
</div>
</div>
</div>
<p>The prior predictive is quite wide, with a very long and somewhat fat tail, but overall the data could be plausibly seen as coming from it.</p>
</section>
<section id="inference-and-diagnostics" class="level3" data-number="1.4.5">
<h3 data-number="1.4.5" class="anchored" data-anchor-id="inference-and-diagnostics"><span class="header-section-number">1.4.5</span> Inference and diagnostics</h3>
<p>Next, we perform the actual inference step - we sample from the posterior and the posterior predictive distribution:</p>
<div id="0ee4f78c-b89f-49b9-9f02-e7a014ea61b2" class="cell">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> unpooled_negb:</span>
<span id="cb39-2">    unpooled_idata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.sample(target_accept<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, idata_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log_likelihood"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>})</span>
<span id="cb39-3">    pm.sample_posterior_predictive(unpooled_idata, extend_inferencedata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [μ, α]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 5 seconds.
Sampling: [y]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:04&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="4000" class="" max="4000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [4000/4000 00:00&lt;00:00]
    </div>
    
</div>
</div>
<p>There are no divergences detected, which is a good first sign that the model has converged.</p>
<p>To check the sampling process we plot the traces for the μ parameter. What we are looking for is similar densities on the left (indicating that the chains have converged to the same posterior distribution), and noisy/patternless trace plots on the right (which would indicate that the sampler was able to efficiently run through the sample space)<sup>2</sup>:</p>
<div id="cell-fig-unpooled-traceplots" class="cell">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1">az.plot_trace(unpooled_idata, var_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ"</span>], compact<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-unpooled-traceplots" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-unpooled-traceplots-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-unpooled-traceplots-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-unpooled-traceplots-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Traceplots of the inferred parameter μ for the unpooled model
</figcaption>
</figure>
</div>
</div>
</div>
<p>There are a few kinks here and there (see RIC), but overall these look good.</p>
<p>Next we plot the <a href="https://python.arviz.org/en/latest/api/generated/arviz.plot_energy.html#r74895e2d4323-1">energy plot</a> and <a href="https://python.arviz.org/en/latest/api/generated/arviz.bfmi.html#arviz.bfmi">BFMI</a>. Ideally the marginal energy and energy transition distributions should overlap as much as possible, and BFMI should be to be above .3:</p>
<div id="cell-fig-unpooled-energy" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> az.plot_energy(unpooled_idata)</span>
<span id="cb42-2">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Energy Plot"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-unpooled-energy" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-unpooled-energy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-unpooled-energy-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-unpooled-energy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Energy plot for the unpooled model
</figcaption>
</figure>
</div>
</div>
</div>
<p>Finally, we check the summary statistics for the μ parameter:</p>
<ul>
<li>bulk and tail effective sample size (<code>ess_bulk</code> and <code>ess_tail</code> respectively) should be &gt; 400, otherwise the estimation of the rest of the summary statistics is considered unreliable <sup>3</sup></li>
<li><code>r_hat</code> should ideally equal 1, with values over 1.01 convergence issues <sup>4</sup></li>
<li><code>mcse_{mean, sd}</code> is the Monte Carlo Standard Error, or the error introduced by approximating the posterior with a finite number of samples; lower = better <sup>5</sup></li>
</ul>
<div id="ad237f09-d7b1-41fe-acf7-05cb178d0446" class="cell">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1">az.summary(unpooled_idata, var_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ"</span>])</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_3%</th>
<th data-quarto-table-cell-role="th">hdi_97%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[ALB]</td>
<td>2.559</td>
<td>0.113</td>
<td>2.356</td>
<td>2.786</td>
<td>0.002</td>
<td>0.001</td>
<td>5027.0</td>
<td>2717.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[ALO]</td>
<td>3.124</td>
<td>0.101</td>
<td>2.925</td>
<td>3.308</td>
<td>0.002</td>
<td>0.001</td>
<td>4219.0</td>
<td>2969.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[BOT]</td>
<td>2.523</td>
<td>0.190</td>
<td>2.158</td>
<td>2.878</td>
<td>0.003</td>
<td>0.002</td>
<td>4131.0</td>
<td>2642.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[DEV]</td>
<td>1.766</td>
<td>0.220</td>
<td>1.350</td>
<td>2.179</td>
<td>0.004</td>
<td>0.003</td>
<td>3568.0</td>
<td>2298.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[GAS]</td>
<td>2.459</td>
<td>0.221</td>
<td>2.039</td>
<td>2.874</td>
<td>0.003</td>
<td>0.002</td>
<td>4298.0</td>
<td>2631.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[HAM]</td>
<td>3.085</td>
<td>0.099</td>
<td>2.907</td>
<td>3.279</td>
<td>0.001</td>
<td>0.001</td>
<td>4774.0</td>
<td>2917.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[HUL]</td>
<td>2.159</td>
<td>0.151</td>
<td>1.888</td>
<td>2.452</td>
<td>0.002</td>
<td>0.002</td>
<td>4008.0</td>
<td>2570.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[LEC]</td>
<td>2.723</td>
<td>0.209</td>
<td>2.311</td>
<td>3.114</td>
<td>0.003</td>
<td>0.002</td>
<td>4991.0</td>
<td>2884.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[MAG]</td>
<td>2.030</td>
<td>0.258</td>
<td>1.552</td>
<td>2.523</td>
<td>0.004</td>
<td>0.003</td>
<td>4224.0</td>
<td>2823.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[NOR]</td>
<td>2.695</td>
<td>0.146</td>
<td>2.416</td>
<td>2.960</td>
<td>0.002</td>
<td>0.002</td>
<td>4055.0</td>
<td>2487.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[OCO]</td>
<td>2.275</td>
<td>0.280</td>
<td>1.764</td>
<td>2.818</td>
<td>0.004</td>
<td>0.003</td>
<td>4511.0</td>
<td>2902.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[PER]</td>
<td>3.283</td>
<td>0.101</td>
<td>3.086</td>
<td>3.472</td>
<td>0.001</td>
<td>0.001</td>
<td>4856.0</td>
<td>3012.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[PIA]</td>
<td>1.901</td>
<td>0.276</td>
<td>1.373</td>
<td>2.416</td>
<td>0.005</td>
<td>0.003</td>
<td>3901.0</td>
<td>2514.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[RIC]</td>
<td>2.338</td>
<td>0.226</td>
<td>1.948</td>
<td>2.791</td>
<td>0.003</td>
<td>0.002</td>
<td>4746.0</td>
<td>2388.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[RUS]</td>
<td>2.776</td>
<td>0.165</td>
<td>2.480</td>
<td>3.097</td>
<td>0.002</td>
<td>0.002</td>
<td>4741.0</td>
<td>2662.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[SAI]</td>
<td>2.661</td>
<td>0.176</td>
<td>2.338</td>
<td>3.005</td>
<td>0.003</td>
<td>0.002</td>
<td>4280.0</td>
<td>2802.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[SAR]</td>
<td>1.835</td>
<td>0.451</td>
<td>1.023</td>
<td>2.665</td>
<td>0.007</td>
<td>0.005</td>
<td>4104.0</td>
<td>2613.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[STR]</td>
<td>2.182</td>
<td>0.260</td>
<td>1.709</td>
<td>2.681</td>
<td>0.004</td>
<td>0.003</td>
<td>3834.0</td>
<td>2291.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[TSU]</td>
<td>2.420</td>
<td>0.122</td>
<td>2.196</td>
<td>2.660</td>
<td>0.002</td>
<td>0.001</td>
<td>4081.0</td>
<td>2713.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[VER]</td>
<td>3.742</td>
<td>0.074</td>
<td>3.607</td>
<td>3.886</td>
<td>0.001</td>
<td>0.001</td>
<td>5036.0</td>
<td>2571.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[ZHO]</td>
<td>2.255</td>
<td>0.237</td>
<td>1.798</td>
<td>2.699</td>
<td>0.003</td>
<td>0.003</td>
<td>4903.0</td>
<td>2624.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>All of the sampling diagnistics look good, which means the model has converged and we can move on to posterior predictive checks and model evaluation.</p>
</section>
<section id="posterior-predictive-checks" class="level3" data-number="1.4.6">
<h3 data-number="1.4.6" class="anchored" data-anchor-id="posterior-predictive-checks"><span class="header-section-number">1.4.6</span> Posterior predictive checks</h3>
<p>Next we examine the posterior predictive distribution, which will help validate that the predictions the model is making make sense given the data. Below we plot several posterior graphs (from top to bottom, left to right):</p>
<ul>
<li>the (grouped) posterior predictive distribution should closely replicate the pattern seen in the observed data <sup>6</sup></li>
<li>the Bayesian p-value is the probability of the predicted data being equal to or less than the observed data. The ideal/expected outcome is represented by the dashed line (0.5), with the solid line being the KDE of the predicted data; the u-value represents the same idea as the p-value, but per observation - it should be roughly uniform <sup>7</sup></li>
<li>LOO-PIT is the probability integral transform checed with LOO-CV; this should be close to uniform; difference between LOO-PIT empirical cumulative distribution function and the uniform cdf <sup>8</sup></li>
</ul>
<div id="2d860ab9-1bb9-4e29-a2aa-8733103ddf61" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> plot_posterior_predictive_checks(idata):</span>
<span id="cb44-2">    f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb44-3"></span>
<span id="cb44-4">    ax_ppc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f.add_subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb44-5">    az.plot_ppc(idata, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax_ppc)</span>
<span id="cb44-6">    ax_ppc.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior predictive checks"</span>)</span>
<span id="cb44-7"></span>
<span id="cb44-8">    ax_bpv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f.add_subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb44-9">    az.plot_bpv(idata, kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p_value"</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax_bpv)</span>
<span id="cb44-10">    ax_bpv.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bayesian p_value"</span>)</span>
<span id="cb44-11"></span>
<span id="cb44-12">    ax_uv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f.add_subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb44-13">    az.plot_bpv(idata, kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"u_value"</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax_uv)</span>
<span id="cb44-14">    ax_uv.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginal p_value"</span>)</span>
<span id="cb44-15"></span>
<span id="cb44-16">    ax_loo_pit_ecdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f.add_subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb44-17">    az.plot_loo_pit(idata, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>, ecdf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax_loo_pit_ecdf)</span>
<span id="cb44-18">    ax_loo_pit_ecdf.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LOO-PIT (ecdf=True)"</span>)</span>
<span id="cb44-19"></span>
<span id="cb44-20">    ax_loo_pit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f.add_subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb44-21">    az.plot_loo_pit(idata, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>, ecdf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax_loo_pit)</span>
<span id="cb44-22">    ax_loo_pit.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LOO-PIT (ecdf=False)"</span>)</span>
<span id="cb44-23"></span>
<span id="cb44-24">    f.tight_layout()</span>
<span id="cb44-25"></span>
<span id="cb44-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (ax_ppc, ax_bpv, ax_uv, ax_loo_pit_ecdf, ax_loo_pit)</span></code></pre></div>
</details>
</div>
<div id="cell-fig-unpooled-ppc" class="cell">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1">plot_posterior_predictive_checks(unpooled_idata)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-unpooled-ppc" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-unpooled-ppc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-unpooled-ppc-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-unpooled-ppc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Posterior predictive checks, u/p-value, and LOO for the unpooled model
</figcaption>
</figure>
</div>
</div>
</div>
<p>From the posterior predictive plots it seems that:</p>
<ul>
<li>the posterior predictive samples roughly look like tha observed data, but the fit around the right tail isn’t the best.</li>
<li>the p-value plot shows that the model’s predictions are somewhat shifted to the right and the u-value plot indicates that the model is missing observations in the left tail <sup>9</sup></li>
<li>LOO-PIT shows the model is likely biased, which agrees with the p/u-value plots.</li>
</ul>
<p>Lastly, let’s plot the posterior predictive distributions for a few individual drivers:</p>
<div id="cell-fig-unpooled-ppc-individual" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1">fig, axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb46-2"></span>
<span id="cb46-3">DriverIdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Enum(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Driver"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(labels.categories, labels.codes))</span>
<span id="cb46-4"></span>
<span id="cb46-5">az.plot_ppc(unpooled_idata, coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idx"</span>: [DriverIdx.VER.value]}, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb46-6">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"VER"</span>)</span>
<span id="cb46-7"></span>
<span id="cb46-8">az.plot_ppc(unpooled_idata, coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idx"</span>: [DriverIdx.SAR.value]}, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb46-9">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SAR"</span>)</span>
<span id="cb46-10"></span>
<span id="cb46-11">az.plot_ppc(unpooled_idata, coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idx"</span>: [DriverIdx.LEC.value]}, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb46-12">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LEC"</span>)</span>
<span id="cb46-13"></span>
<span id="cb46-14">az.plot_ppc(unpooled_idata, coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idx"</span>: [DriverIdx.HAM.value]}, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb46-15">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HAM"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-unpooled-ppc-individual" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-unpooled-ppc-individual-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-unpooled-ppc-individual-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-unpooled-ppc-individual-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: Posterior predictive plots of individual drivers for the unpooled model
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="posterior-evaluation" class="level3" data-number="1.4.7">
<h3 data-number="1.4.7" class="anchored" data-anchor-id="posterior-evaluation"><span class="header-section-number">1.4.7</span> Posterior evaluation</h3>
<p>We are reasonably confident that the model has converged and that there were no issues during sampling. Predictions seem to be somewhat biased, but still reasonable for our purposes. Now it’s time to check the posterior distributions of the estimated parameter μ:</p>
<div id="cell-fig-unpooled-posterior-mean" class="cell">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1">az.plot_posterior(unpooled_idata, var_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ"</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-unpooled-posterior-mean" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-unpooled-posterior-mean-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-unpooled-posterior-mean-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-unpooled-posterior-mean-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;14: Posterior distributions of the μ parameter for the unpooled model
</figcaption>
</figure>
</div>
</div>
</div>
<p>The estimates look well formed; to make comparing the parameter value between drivers easier, we plot a forest of the 94% HDI <sup>10</sup>:</p>
<div id="cell-fig-unpooled-posterior-forest-log" class="cell">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1">az.plot_forest(unpooled_idata, var_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ"</span>], combined<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-unpooled-posterior-forest-log" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-unpooled-posterior-forest-log-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-unpooled-posterior-forest-log-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-unpooled-posterior-forest-log-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15: Forest of the posterior distributions of μ for the unpooled model (log scale)
</figcaption>
</figure>
</div>
</div>
</div>
<p>The probability distributions for the means broadly agree with our informal observations throughout the season - VER is scoring high above the rest, in an extremely consistent range, with HAM, ALO, and PER close to eachother for second place, a mixed, variable set of results for the midfield, and a few clear backmarker drivers.</p>
<p>To translate the estimated parameter values to points, we can plot the transformed μ_ value (remember that this is just the exponentiated μ):</p>
<div id="cell-fig-unpooled-posterior-forest" class="cell">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1">az.plot_forest(unpooled_idata, var_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ_"</span>], combined<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-unpooled-posterior-forest" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-unpooled-posterior-forest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-unpooled-posterior-forest-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-unpooled-posterior-forest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16: Forest of the posterior distributions of μ for the unpooled model
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="model-evaluation" class="level3" data-number="1.4.8">
<h3 data-number="1.4.8" class="anchored" data-anchor-id="model-evaluation"><span class="header-section-number">1.4.8</span> Model evaluation</h3>
<p>Finally, we inspect <a href="https://python.arviz.org/en/stable/api/generated/arviz.loo.html">PSIS-LOO-CV</a> to get an idea of the performance of the model:</p>
<div id="24b54d3e-43ef-4870-b6d0-a189d424a40b" class="cell">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1">az.loo(unpooled_idata)</span></code></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Computed from 4000 posterior samples and 280 observations log-likelihood matrix.

         Estimate       SE
elpd_loo  -954.78    14.99
p_loo       44.52        -

There has been a warning during the calculation. Please check the results.
------

Pareto k diagnostic values:
                         Count   Pct.
(-Inf, 0.5]   (good)      274   97.9%
 (0.5, 0.7]   (ok)          5    1.8%
   (0.7, 1]   (bad)         1    0.4%
   (1, Inf)   (very bad)    0    0.0%</code></pre>
</div>
</div>
<p><code>elpd_loo</code> <sup>11</sup> will be more useful when comparing this baseline model to other, more complicated ones, but the fact that Pareto k values are all significantly below 0.7 is a good sign that the model can generalize decently.</p>
</section>
</section>
<section id="zero-inflated-unpooled-model" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="zero-inflated-unpooled-model"><span class="header-section-number">1.5</span> Zero-inflated unpooled model</h2>
<p>One of the common issues with both <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.Poisson.html#pymc.Poisson">Poisson</a> and <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.NegativeBinomial.html#pymc.NegativeBinomial">Negative Binomial</a> models is that they do not generate zeroes often enough. This can be alleviated by using a mixture model that inflates the number of zeroes, which <code>PyMC</code> already has an implementation of - the <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.ZeroInflatedNegativeBinomial.html">Zero Inflated Negative Binomial likelihood</a>.</p>
<p>To test that extra zeroes might result in a better fit, we define a new model with the same priors as before, but using the mixture likelihood. One additional parameter, ψ, is needed, so we have to set a prior over that. ψ is the probability of a non-zero value, between 0 and 1. We will use a <a href="https://www.pymc.io/projects/docs/en/stable/api/distributions/generated/pymc.Beta.html">Beta</a> as the prior distribution, and given the ruleset and reliability of modern F1 cars, our prior belief is that 0 point finishes aren’t all that likely. To express that, we take the maximum entropy Beta whose mass is concentrated between .8 and .99:</p>
<section id="choosing-priors" class="level3" data-number="1.5.1">
<h3 data-number="1.5.1" class="anchored" data-anchor-id="choosing-priors"><span class="header-section-number">1.5.1</span> Choosing priors</h3>
<div id="cell-fig-zi-psi-prior" class="cell">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1">psi_dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pz.Beta()</span>
<span id="cb52-2">pz.maxent(psi_dist, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-zi-psi-prior" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-zi-psi-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-zi-psi-prior-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-zi-psi-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;17: Prior distribution for the ψ parameter (probability of a non-zero value)
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="model-definition-1" class="level3" data-number="1.5.2">
<h3 data-number="1.5.2" class="anchored" data-anchor-id="model-definition-1"><span class="header-section-number">1.5.2</span> Model definition</h3>
<p>The new model is trivial to define:</p>
<div id="902dfe17-151d-46cc-864d-36147dc7029b" class="cell">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> pm.Model(coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>: labels, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idx"</span>: idx}) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> zi_unpooled_negb:</span>
<span id="cb53-2">    μ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Normal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ"</span>, mu_dist.mu, mu_dist.sigma, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>)</span>
<span id="cb53-3">    μ_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ_"</span>, pm.math.exp(μ), dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>)</span>
<span id="cb53-4"></span>
<span id="cb53-5">    α <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Gamma(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"α"</span>, alpha_dist.alpha, alpha_dist.beta, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>)</span>
<span id="cb53-6"></span>
<span id="cb53-7">    ψ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Beta(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ψ"</span>, psi_dist.alpha, psi_dist.beta, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"driver"</span>)</span>
<span id="cb53-8"></span>
<span id="cb53-9">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.ZeroInflatedNegativeBinomial(</span>
<span id="cb53-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>,</span>
<span id="cb53-11">        psi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ψ[idx],</span>
<span id="cb53-12">        alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>α[idx],</span>
<span id="cb53-13">        mu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>μ_[idx],</span>
<span id="cb53-14">        observed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>driver_points,</span>
<span id="cb53-15">        dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idx"</span>,</span>
<span id="cb53-16">    )</span></code></pre></div>
</div>
</section>
<section id="prior-evaluation" class="level3" data-number="1.5.3">
<h3 data-number="1.5.3" class="anchored" data-anchor-id="prior-evaluation"><span class="header-section-number">1.5.3</span> Prior evaluation</h3>
<p>We perform the same prior predictive check:</p>
<div id="c8aab7d7-fe18-4601-9080-6395780ca1b5" class="cell">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> zi_unpooled_negb:</span>
<span id="cb54-2">    zi_unpooled_prior_samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.sample_prior_predictive(samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [y, α, μ, ψ]</code></pre>
</div>
</div>
<div id="cell-fig-zi-prior-predictive" class="cell">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1">az.plot_ppc(zi_unpooled_prior_samples, group<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prior"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-zi-prior-predictive" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-zi-prior-predictive-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-zi-prior-predictive-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-zi-prior-predictive-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18: Prior predictive distribution for the zero-inflated model
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="inference-and-diagnostics-1" class="level3" data-number="1.5.4">
<h3 data-number="1.5.4" class="anchored" data-anchor-id="inference-and-diagnostics-1"><span class="header-section-number">1.5.4</span> Inference and diagnostics</h3>
<p>Sample:</p>
<div id="035e7f1e-1d50-4e92-9014-1f41d95f9dce" class="cell">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> zi_unpooled_negb:</span>
<span id="cb57-2">    zi_unpooled_idata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.sample(</span>
<span id="cb57-3">        target_accept<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, idata_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log_likelihood"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>}</span>
<span id="cb57-4">    )</span>
<span id="cb57-5">    pm.sample_posterior_predictive(zi_unpooled_idata, extend_inferencedata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [μ, α, ψ]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 10 seconds.
Sampling: [y]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:09&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="4000" class="" max="4000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [4000/4000 00:05&lt;00:00]
    </div>
    
</div>
</div>
<p>The traceplots look about as good as before:</p>
<div id="cell-fig-zi-traceplots" class="cell">
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1">az.plot_trace(zi_unpooled_idata, var_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ"</span>], compact<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-zi-traceplots" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-zi-traceplots-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-zi-traceplots-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-zi-traceplots-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19: Traceplots of the μ parameter for the zero-inflated model
</figcaption>
</figure>
</div>
</div>
</div>
<p>BFMI and energy are reasonable:</p>
<div id="cell-fig-zi-energy" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> az.plot_energy(zi_unpooled_idata)</span>
<span id="cb60-2">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Energy Plot"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-zi-energy" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-zi-energy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-zi-energy-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-zi-energy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20: Energy plot for the zero-inflated model
</figcaption>
</figure>
</div>
</div>
</div>
<p><code>r_hat</code> and ESS look good as well:</p>
<div id="4b34e573-eba8-4077-ba7f-97d022ac38cb" class="cell">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1">az.summary(zi_unpooled_idata, var_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ"</span>])</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_3%</th>
<th data-quarto-table-cell-role="th">hdi_97%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[ALB]</td>
<td>2.558</td>
<td>0.111</td>
<td>2.343</td>
<td>2.762</td>
<td>0.001</td>
<td>0.001</td>
<td>6450.0</td>
<td>3026.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[ALO]</td>
<td>3.123</td>
<td>0.100</td>
<td>2.942</td>
<td>3.322</td>
<td>0.001</td>
<td>0.001</td>
<td>6609.0</td>
<td>2903.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[BOT]</td>
<td>2.655</td>
<td>0.128</td>
<td>2.417</td>
<td>2.900</td>
<td>0.002</td>
<td>0.001</td>
<td>6154.0</td>
<td>2859.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[DEV]</td>
<td>1.907</td>
<td>0.183</td>
<td>1.581</td>
<td>2.273</td>
<td>0.002</td>
<td>0.001</td>
<td>7928.0</td>
<td>2908.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[GAS]</td>
<td>2.499</td>
<td>0.208</td>
<td>2.115</td>
<td>2.907</td>
<td>0.003</td>
<td>0.002</td>
<td>6758.0</td>
<td>2526.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[HAM]</td>
<td>3.082</td>
<td>0.097</td>
<td>2.898</td>
<td>3.264</td>
<td>0.001</td>
<td>0.001</td>
<td>7940.0</td>
<td>2852.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[HUL]</td>
<td>2.222</td>
<td>0.139</td>
<td>1.965</td>
<td>2.484</td>
<td>0.002</td>
<td>0.001</td>
<td>6692.0</td>
<td>2804.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[LEC]</td>
<td>2.876</td>
<td>0.143</td>
<td>2.590</td>
<td>3.128</td>
<td>0.002</td>
<td>0.001</td>
<td>6002.0</td>
<td>2722.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[MAG]</td>
<td>2.237</td>
<td>0.149</td>
<td>1.947</td>
<td>2.507</td>
<td>0.002</td>
<td>0.001</td>
<td>6121.0</td>
<td>2629.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[NOR]</td>
<td>2.700</td>
<td>0.144</td>
<td>2.436</td>
<td>2.974</td>
<td>0.002</td>
<td>0.001</td>
<td>7691.0</td>
<td>3154.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[OCO]</td>
<td>2.511</td>
<td>0.166</td>
<td>2.197</td>
<td>2.832</td>
<td>0.002</td>
<td>0.002</td>
<td>6137.0</td>
<td>2785.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[PER]</td>
<td>3.282</td>
<td>0.105</td>
<td>3.080</td>
<td>3.478</td>
<td>0.001</td>
<td>0.001</td>
<td>6747.0</td>
<td>2638.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[PIA]</td>
<td>2.078</td>
<td>0.183</td>
<td>1.698</td>
<td>2.395</td>
<td>0.002</td>
<td>0.002</td>
<td>5952.0</td>
<td>2692.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[RIC]</td>
<td>2.335</td>
<td>0.216</td>
<td>1.906</td>
<td>2.717</td>
<td>0.003</td>
<td>0.002</td>
<td>7119.0</td>
<td>2722.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[RUS]</td>
<td>2.850</td>
<td>0.135</td>
<td>2.612</td>
<td>3.122</td>
<td>0.002</td>
<td>0.001</td>
<td>5916.0</td>
<td>2873.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[SAI]</td>
<td>2.728</td>
<td>0.154</td>
<td>2.448</td>
<td>3.019</td>
<td>0.002</td>
<td>0.001</td>
<td>5981.0</td>
<td>2686.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[SAR]</td>
<td>2.036</td>
<td>0.213</td>
<td>1.672</td>
<td>2.461</td>
<td>0.003</td>
<td>0.002</td>
<td>4655.0</td>
<td>2695.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[STR]</td>
<td>2.420</td>
<td>0.135</td>
<td>2.167</td>
<td>2.681</td>
<td>0.002</td>
<td>0.001</td>
<td>6232.0</td>
<td>2915.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[TSU]</td>
<td>2.417</td>
<td>0.123</td>
<td>2.177</td>
<td>2.641</td>
<td>0.001</td>
<td>0.001</td>
<td>7217.0</td>
<td>2763.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">μ[VER]</td>
<td>3.742</td>
<td>0.074</td>
<td>3.609</td>
<td>3.890</td>
<td>0.001</td>
<td>0.001</td>
<td>6489.0</td>
<td>2464.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">μ[ZHO]</td>
<td>2.424</td>
<td>0.161</td>
<td>2.105</td>
<td>2.713</td>
<td>0.002</td>
<td>0.001</td>
<td>6419.0</td>
<td>2791.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
<section id="posterior-predictive-checks-1" class="level3" data-number="1.5.5">
<h3 data-number="1.5.5" class="anchored" data-anchor-id="posterior-predictive-checks-1"><span class="header-section-number">1.5.5</span> Posterior predictive checks</h3>
<p>Posterior predictive checks look somewhat better:</p>
<ul>
<li>the posterior predictive fits about as well, with a slightly thinner tail</li>
<li>p-value is still shifted</li>
<li>u-value is much closer to uniform</li>
<li>LOO-PIT still suggests bias, but it looks slightly better overall; the right tail of the posterior predictive still looks too fat and goes well above the maximum points possible in the ruleset, likely causing the bias and shifted predictions.</li>
</ul>
<div id="cell-fig-zi-ppc" class="cell">
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1">plot_posterior_predictive_checks(zi_unpooled_idata)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-zi-ppc" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-zi-ppc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-zi-ppc-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-zi-ppc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;21: Posterior predictive checks, p/u-value, and LOO for the zero-inflated model
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="posterior-evaluation-1" class="level3" data-number="1.5.6">
<h3 data-number="1.5.6" class="anchored" data-anchor-id="posterior-evaluation-1"><span class="header-section-number">1.5.6</span> Posterior evaluation</h3>
<p>We plot just the forest of transformed means:</p>
<div id="cell-fig-zi-mu-forest" class="cell">
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1">az.plot_forest(zi_unpooled_idata, var_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ_"</span>], combined<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-zi-mu-forest" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-zi-mu-forest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-zi-mu-forest-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-zi-mu-forest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;22: Forest plot of the posterior distribution of the exponentiated μ parameter for the zero-inflated model
</figcaption>
</figure>
</div>
</div>
</div>
<p>As expected, compared to the basic model, the means have been pulled towards zero slightly and the HDIs have shrunk.</p>
</section>
<section id="model-comparison" class="level3" data-number="1.5.7">
<h3 data-number="1.5.7" class="anchored" data-anchor-id="model-comparison"><span class="header-section-number">1.5.7</span> Model comparison</h3>
<p>Now that we have two models it’s worth running a comparison to see which performs better <sup>12</sup>:</p>
<div id="6c9966ab-1a72-4370-a4c5-7245c53eab08" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1">comparison <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> az.compare(</span>
<span id="cb64-2">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unpooled"</span>: unpooled_idata, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zero inflated unpooled"</span>: zi_unpooled_idata}</span>
<span id="cb64-3">)</span>
<span id="cb64-4">comparison</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">rank</th>
<th data-quarto-table-cell-role="th">elpd_loo</th>
<th data-quarto-table-cell-role="th">p_loo</th>
<th data-quarto-table-cell-role="th">elpd_diff</th>
<th data-quarto-table-cell-role="th">weight</th>
<th data-quarto-table-cell-role="th">se</th>
<th data-quarto-table-cell-role="th">dse</th>
<th data-quarto-table-cell-role="th">warning</th>
<th data-quarto-table-cell-role="th">scale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">zero inflated unpooled</td>
<td>0</td>
<td>-922.394375</td>
<td>40.951957</td>
<td>0.000000</td>
<td>0.787666</td>
<td>17.265214</td>
<td>0.000000</td>
<td>False</td>
<td>log</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">unpooled</td>
<td>1</td>
<td>-954.778337</td>
<td>44.522890</td>
<td>32.383962</td>
<td>0.212334</td>
<td>14.990548</td>
<td>11.918236</td>
<td>True</td>
<td>log</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="cell-fig-zi-comparison" class="cell">
<div class="sourceCode cell-code" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1">az.plot_compare(comparison)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-zi-comparison" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-zi-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-zi-comparison-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-zi-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;23: Comparison of the performance of the unpooled and zero-inflated models
</figcaption>
</figure>
</div>
</div>
</div>
<p>The zero-inflated model clearly seems to perform better <sup>13</sup>.</p>
</section>
</section>
<section id="driver-estimates" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="driver-estimates"><span class="header-section-number">1.6</span> Driver estimates</h2>
<p>We have a reasonable looking, if a bit biased model for driver points, which we’ll now use to inform fantasy team construction.</p>
<p>When picking drivers, we consider the following:</p>
<ul>
<li>how many points per race is the driver expected to bring and how reliably</li>
<li>how likely is it that a given driver will outperform another driver, and by what magnitude</li>
<li>how underpriced/overpriced is a a driver given their performance</li>
</ul>
<p>While price analysis is out of the scope of this notebook, the points estimation model can help us with the first two questions.</p>
<p>Below, we compare each driver to their rivals, using the difference of predicted points per race. To do so, we take the predictions generated from the posterior predictive distribution for each driver, subtract the two vectors, and take the mean. This reduces the posterior distributions to a point estimate, but still incorporates the uncertainty of the model, as we work directly with values generated from the posterior. The value can be seen both as confidence driver x is better than driver y - higher is better, and as the points we expect driver x to earn over driver y on average.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>The plot below isn’t symmetric over the right diagonal - we are strictly comparing the driver on the X axis to the driver on the Y axis.</p>
</div>
</div>
<div id="835259e7-89ee-473b-bfe0-dcfb00c493db" class="cell">
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> make_comparison(idata, idx, groups, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>):</span>
<span id="cb66-2">    columns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb66-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> idx_a, name_a <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(groups):</span>
<span id="cb66-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> idx_b, name_b <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(groups):</span>
<span id="cb66-5">            pp_a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> idata.posterior_predictive[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>][:, :, idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> idx_a].values.flatten()</span>
<span id="cb66-6">            pp_b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> idata.posterior_predictive[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>][:, :, idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> idx_b].values.flatten()</span>
<span id="cb66-7"></span>
<span id="cb66-8">            samples_a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.choice(pp_a, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>size)</span>
<span id="cb66-9">            samples_b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.choice(pp_b, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>size)</span>
<span id="cb66-10"></span>
<span id="cb66-11">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> idx_a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> idx_b:</span>
<span id="cb66-12">                points_over <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (samples_a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> samples_b).mean()</span>
<span id="cb66-13">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb66-14">                points_over <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb66-15"></span>
<span id="cb66-16">            columns.setdefault(name_a, []).append(points_over)</span>
<span id="cb66-17"></span>
<span id="cb66-18">    comparison_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame.from_dict(columns).set_index(groups)</span>
<span id="cb66-19">    mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.triu(np.ones_like(comparison_df, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>))</span>
<span id="cb66-20"></span>
<span id="cb66-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> comparison_df, mask</span></code></pre></div>
</div>
<div id="f3121ac4-27ee-4a41-bce6-e3a0a216f27a" class="cell">
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1">comparison_df, mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_comparison(zi_unpooled_idata, idx, labels)</span></code></pre></div>
</div>
<div id="cell-fig-drivers-comparison" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1">sns.set_theme(style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>)</span>
<span id="cb68-2"></span>
<span id="cb68-3">cmap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.diverging_palette(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">230</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, as_cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb68-4"></span>
<span id="cb68-5">f, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>))</span>
<span id="cb68-6"></span>
<span id="cb68-7">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.heatmap(</span>
<span id="cb68-8">    comparison_df,</span>
<span id="cb68-9">    cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cmap,</span>
<span id="cb68-10">    mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mask,</span>
<span id="cb68-11">    annot<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb68-12">    center<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb68-13">    square<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb68-14">    linewidths<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb68-15">    cbar_kws<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shrink"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>},</span>
<span id="cb68-16">    annot_kws<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fontsize"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>},</span>
<span id="cb68-17">).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Driver points expected over rival"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-drivers-comparison" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-drivers-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-drivers-comparison-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-drivers-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;24: Expected points earned by driver x over driver y using the zero-inflated model
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="constructor-estimates" class="level2" data-number="1.7">
<h2 data-number="1.7" class="anchored" data-anchor-id="constructor-estimates"><span class="header-section-number">1.7</span> Constructor estimates</h2>
<p>We’ll run the same loop for the constructor comparison - first we define a slightly modified zero inflated model, then we sample, validate convergence, and finally use the posterior and posterior predictive to evaluate constructor peformance.</p>
<p>Data preparation is identical - we factorize the constructors and take the points</p>
<div id="469a38ca-57c1-453a-93a1-7304af9bc8b6" class="cell">
<div class="sourceCode cell-code" id="cb69" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1">const_idx, const_labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.factorize(const_data_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>], sort<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb69-2">const_points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> const_data_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor_points"</span>]</span></code></pre></div>
</div>
<p>We adjust the priors slightly, to account for differences in the constructors scoring system:</p>
<div id="cell-fig-constructors-mu-prior" class="cell">
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1">mu_const_dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pz.Normal()</span>
<span id="cb70-2">pz.maxent(mu_const_dist, np.log(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), np.log(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-constructors-mu-prior" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-constructors-mu-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-constructors-mu-prior-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-constructors-mu-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;25: Prior for the μ parameter for fitting the zero inflated model to the constructor data
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-constructors-alpha-prior" class="cell">
<div class="sourceCode cell-code" id="cb71" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1">alpha_const_dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pz.Gamma()</span>
<span id="cb71-2">pz.maxent(alpha_const_dist, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-constructors-alpha-prior" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-constructors-alpha-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-constructors-alpha-prior-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-constructors-alpha-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;26: Prior for the α parameter for fitting the zero inflated model to the constructor data
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-constructors-psi-prior" class="cell">
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1">psi_const_dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pz.Beta()</span>
<span id="cb72-2">pz.maxent(psi_const_dist, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.99</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.9</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-constructors-psi-prior" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-constructors-psi-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-constructors-psi-prior-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-constructors-psi-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;27: Prior for the ψ parameter for fitting the zero inflated model to the constructor data
</figcaption>
</figure>
</div>
</div>
</div>
<div id="df2fe1ee-dbe4-4090-a7fd-5058fff461dc" class="cell">
<div class="sourceCode cell-code" id="cb73" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> pm.Model(</span>
<span id="cb73-2">    coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>: const_labels, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idx"</span>: const_idx}</span>
<span id="cb73-3">) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> const_zi_unpooled_model:</span>
<span id="cb73-4">    μ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Normal(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ"</span>, mu_const_dist.mu, mu_const_dist.sigma, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>)</span>
<span id="cb73-5">    μ_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Deterministic(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ_"</span>, pm.math.exp(μ), dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>)</span>
<span id="cb73-6"></span>
<span id="cb73-7">    α <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Gamma(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"α"</span>, alpha_const_dist.alpha, alpha_const_dist.beta, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>)</span>
<span id="cb73-8"></span>
<span id="cb73-9">    ψ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.Beta(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ψ"</span>, psi_const_dist.alpha, psi_const_dist.beta, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constructor"</span>)</span>
<span id="cb73-10"></span>
<span id="cb73-11">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.ZeroInflatedNegativeBinomial(</span>
<span id="cb73-12">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>,</span>
<span id="cb73-13">        psi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ψ[const_idx],</span>
<span id="cb73-14">        alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>α[const_idx],</span>
<span id="cb73-15">        mu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>μ_[const_idx],</span>
<span id="cb73-16">        observed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>const_points,</span>
<span id="cb73-17">        dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idx"</span>,</span>
<span id="cb73-18">    )</span></code></pre></div>
</div>
<div id="0d9e2ff7-fcce-4cc3-b236-b3ef538737b4" class="cell">
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> const_zi_unpooled_model:</span>
<span id="cb74-2">    const_prior_pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.sample_prior_predictive(samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [y, α, μ, ψ]</code></pre>
</div>
</div>
<div id="cell-fig-constructors-prior-predictive" class="cell">
<div class="sourceCode cell-code" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1">az.plot_ppc(const_prior_pred, group<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prior"</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-constructors-prior-predictive" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-constructors-prior-predictive-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-constructors-prior-predictive-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-constructors-prior-predictive-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;28: Prior predictive distribution for the zero-inflated model when fitted to the constructors data
</figcaption>
</figure>
</div>
</div>
</div>
<div id="e3a5ab14-84c6-41ea-8e87-3b9bea14e17e" class="cell">
<div class="sourceCode cell-code" id="cb77" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> const_zi_unpooled_model:</span>
<span id="cb77-2">    const_idata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pm.sample(target_accept<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, idata_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log_likelihood"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>})</span>
<span id="cb77-3">    pm.sample_posterior_predictive(const_idata, extend_inferencedata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [μ, α, ψ]
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 6 seconds.
Sampling: [y]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:05&lt;00:00 Sampling 4 chains, 0 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="4000" class="" max="4000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [4000/4000 00:03&lt;00:00]
    </div>
    
</div>
</div>
<div id="cell-fig-constructors-traceplots" class="cell">
<div class="sourceCode cell-code" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1">az.plot_trace(const_idata, var_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ"</span>], compact<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-constructors-traceplots" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-constructors-traceplots-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-constructors-traceplots-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-constructors-traceplots-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;29: Traceplots of the μ parameter for the zero-inflated model when fitted to the constructors data
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-constructors-ppc" class="cell">
<div class="sourceCode cell-code" id="cb80" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1">plot_posterior_predictive_checks(const_idata)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-constructors-ppc" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-constructors-ppc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-constructors-ppc-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-constructors-ppc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;30: Posterior predictive checks, p/u-value, and LOO for the zero-inflated model when fitted to the constructors data
</figcaption>
</figure>
</div>
</div>
</div>
<div id="974d9dbf-ebc4-4169-a482-baf08e9bd07f" class="cell">
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1">az.loo(const_idata)</span></code></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Computed from 4000 posterior samples and 140 observations log-likelihood matrix.

         Estimate       SE
elpd_loo  -472.93     9.48
p_loo       12.07        -
------

Pareto k diagnostic values:
                         Count   Pct.
(-Inf, 0.5]   (good)      139   99.3%
 (0.5, 0.7]   (ok)          1    0.7%
   (0.7, 1]   (bad)         0    0.0%
   (1, Inf)   (very bad)    0    0.0%</code></pre>
</div>
</div>
<div id="cell-fig-constructors-forest-mu" class="cell">
<div class="sourceCode cell-code" id="cb83" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1">az.plot_forest(const_idata, var_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"μ_"</span>], combined<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-constructors-forest-mu" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-constructors-forest-mu-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-constructors-forest-mu-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-constructors-forest-mu-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;31: Forest of the posterior distribution of the μ parameter for the zero-inflated model when fitted to the constructors data
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-constructors-comparison" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1">sns.set_theme(style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>)</span>
<span id="cb84-2"></span>
<span id="cb84-3">cmap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.diverging_palette(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">230</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, as_cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb84-4"></span>
<span id="cb84-5">f, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>))</span>
<span id="cb84-6"></span>
<span id="cb84-7">comparison_df, mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_comparison(const_idata, const_idx, const_labels)</span>
<span id="cb84-8"></span>
<span id="cb84-9">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.heatmap(</span>
<span id="cb84-10">    comparison_df,</span>
<span id="cb84-11">    cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cmap,</span>
<span id="cb84-12">    mask<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mask,</span>
<span id="cb84-13">    annot<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb84-14">    center<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb84-15">    square<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb84-16">    linewidths<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb84-17">    cbar_kws<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shrink"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>},</span>
<span id="cb84-18">    annot_kws<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fontsize"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>},</span>
<span id="cb84-19">).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Constructor points expected over rival"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-constructors-comparison" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-constructors-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc_files/figure-html/fig-constructors-comparison-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-constructors-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;32: Expected points earned by constructor x over constructor y using the zero-inflated model
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusion" class="level2" data-number="1.8">
<h2 data-number="1.8" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">1.8</span> Conclusion</h2>
<p>None of the results here are that surprising, but it’s nonetheless useful to confirm our intuition for who’s a good pick and who isn’t. That said, the estimates should be taken with more than a grain of salt - the model we used is quite rudimentary (for one, it doesn’t account for performance trends as the season progresses), and modeling the summed fantasy points directly leads to a lot of detail getting obscured and left out.</p>
<div id="bb6fbca7-9d86-4193-95c7-2e5d0c726072" class="cell">
<div class="sourceCode cell-code" id="cb85" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext watermark</span>
<span id="cb85-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>watermark <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>u <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>iv</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The watermark extension is already loaded. To reload it, use:
  %reload_ext watermark
Last updated: Tue Sep 05 2023

Python implementation: CPython
Python version       : 3.11.4
IPython version      : 8.14.0

numpy     : 1.25.2
tqdm      : 4.66.1
json      : 2.0.9
preliz    : 0.3.2
scipy     : 1.10.1
arviz     : 0.16.1
matplotlib: 3.7.2
pymc      : 5.7.2
pandas    : 2.1.0
sys       : 3.11.4 (main, Jun 28 2023, 19:51:46) [GCC]
requests  : 2.31.0
seaborn   : 0.12.2
</code></pre>
</div>
</div>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>see the intro to this for more details: https://www.pymc.io/projects/examples/en/latest/generalized_linear_models/GLM-negative-binomial-regression.html↩︎</p></li>
<li id="fn2"><p>see this for a quick summary of model checking techniques: https://www.pymc.io/projects/docs/en/stable/learn/core_notebooks/pymc_overview.html#model-checking↩︎</p></li>
<li id="fn3"><p>see: https://bayesiancomputationbook.com/markdown/chp_02.html#effective-sample-size↩︎</p></li>
<li id="fn4"><p>see: https://bayesiancomputationbook.com/markdown/chp_02.html#potential-scale-reduction-factor-hat-r↩︎</p></li>
<li id="fn5"><p>see: https://bayesiancomputationbook.com/markdown/chp_02.html#monte-carlo-standard-error↩︎</p></li>
<li id="fn6"><p>see: https://bayesiancomputationbook.com/markdown/chp_02.html#understanding-your-predictions↩︎</p></li>
<li id="fn7"><p>see: https://bayesiancomputationbook.com/markdown/chp_02.html#fig-posterior-predictive-check-pu-values↩︎</p></li>
<li id="fn8"><p>see: https://oriolabrilpla.cat/en/blog/posts/2019/loo-pit-tutorial.html↩︎</p></li>
<li id="fn9"><p>for a detailed guide on interpreting the bpv plots see: https://bayesiancomputationbook.com/markdown/chp_02.html#fig-posterior-predictive-many-examples↩︎</p></li>
<li id="fn10"><p>see: https://sjster.github.io/introduction_to_computational_statistics/docs/Production/PyMC3.html#hdi↩︎</p></li>
<li id="fn11"><p>see: https://bayesiancomputationbook.com/markdown/chp_02.html#cross-validation-and-loo↩︎</p></li>
<li id="fn12"><p>see: https://bayesiancomputationbook.com/markdown/chp_02.html#model-comparison↩︎</p></li>
<li id="fn13"><p>for much more information on cross validation see: https://avehtari.github.io/modelselection/CV-FAQ.html#12_What_is_the_interpretation_of_ELPD__elpd_loo__elpd_diff↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>python</category>
  <category>pymc</category>
  <category>formula1</category>
  <guid>https://kirilzvezdarov.com/posts/fantasy-gp-mcmc/fantasy-gp-mcmc.html</guid>
  <pubDate>Thu, 31 Aug 2023 04:00:00 GMT</pubDate>
</item>
<item>
  <title>Pointer tagging with multiple tags</title>
  <dc:creator>Kiril Zvezdarov</dc:creator>
  <link>https://kirilzvezdarov.com/posts/pointer-tagging/</link>
  <description><![CDATA[ 





<p>This is a short overview of <a href="https://en.wikipedia.org/wiki/Tagged_pointer">pointer tagging</a> in situations where more than one tags or multibit tags are needed. The implementation is in <a href="https://www.rust-lang.org/">Rust</a>, but it should be easy to understand even without knowledge of the language.</p>
<p>The snippet below is part of my attempt to implement a lockfree linked list, as described by <a href="https://timharris.uk/papers/2001-disc.pdf">Harris</a>, with the additional optimizations by <a href="http://www.cse.yorku.ca/~ruppert/papers/lfll.pdf">Fomitchev, Ruppert</a>. The original Harris algorithm uses the least significant bit of the “successor” pointer in each node of the linked list as a deletion mark, to achieve a two phase removal - first, a node is logically deleted by tagging its successor pointer with the mark, and at a later point it is unlinked completely. The optimizations by Fomitchev and Ruppert add a second possible tag at the next least significant bit, as well as a backlink to a previous node, in order to shorten the length and amount of traversals of the linked list a process has to make. The new tag “flags” that the node after the current one is being deleted, and that the flagged node should not be marked until after the deletion of its successor is fully completed.</p>
<p>The two tags need to be manipulated individually when the algorithm is setting the metadata of a node, and (for convenience) as one chunk for when the actual pointer, clear of tags, is needed:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode rust code-with-copy"><code class="sourceCode rust"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> MARK_BIT<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> FLAG_BIT<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> ALL_TAGS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MARK_BIT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> FLAG_BIT<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> tag_at<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>(ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> tag<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-8">    (ptr <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">as</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>tag <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> (tag <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> value <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">as</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span>)) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">as</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> T</span>
<span id="cb1-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">fn</span> is_tagged<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>(ptr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> tag<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-12">    (ptr <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">as</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">usize</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> tag) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> tag</span>
<span id="cb1-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>The constants define the tag locations for the mark and flag, as well as the “mask” (for a lack of a better term) which covers all tags, so that they can be cleared in one go. The mask is just the sum of the tags that it needs to cover - since each tag bit is just an integer with only one of the bits set, e.g.&nbsp;<code>0b01c</code>= for the least significant and <code>0b10</code> for the next least significant, their sum produces an integer whose set bits correspond to the location of all tags. This can be used for things more interesting than clearing the pointer - for example, it allows for multibit tags or storing (small) integer values, all in one function call.</p>
<p>The tagging logic is only slightly different from how it is usually implemented. First, the pointer and the inverse of the tag bit are <code>and</code>-ed, which results in an integer whose tag bit is unset. This in a sense isolates that specific tag, as the integer now is in a “clean” state with respect to it. The result is <code>or</code>-ed with the tag bit value, which will either set the tag bit or keep it unset (the tag value is just the tag bit or 0).</p>
<p>To illustrate, here is a contrived example:</p>
<ol type="1">
<li><p>Initially, <code>let ptr = 1010101100001011</code>, <code>let tag = 1 &lt;&lt; 1</code>, and <code>let value = false</code>. Both tags are set.</p></li>
<li><p><code>ptr &amp; !tag = 1010101100001011 &amp; 1111111111111101 = 1010101100001001</code>. Note that only the targeted tag is unset, otherwise the pointer is the same. It is clean with respect to the target tag.</p></li>
<li><p><code>(ptr &amp; !tag) | 0 = 1010101100001001 | 0 = 1010101100001001</code></p></li>
</ol>
<p>Checking if a tag is set is done just by =and=-ing the pointer and the tag bits and checking that that results in the tag bits. Lastly, since the tag can be multiple bits, clearing the pointer for regular usage can be done by just <code>tag_at(ptr, ALL_TAGS, false)</code>.</p>
<p>Note that working with tagged pointers is tricky and dangerous, as accidentally dereferencing an unclean pointer will lead to <a href="http://dwarffortresswiki.org/index.php/DF2014:Losing">Fun</a>. In Rust, taking the raw pointer produced by the tagging function and dereferencing it would be an <code>unsafe</code> operation, which forces the implementor to take special note of where and how it is used.</p>



 ]]></description>
  <category>rust</category>
  <guid>https://kirilzvezdarov.com/posts/pointer-tagging/</guid>
  <pubDate>Sun, 18 Dec 2016 05:00:00 GMT</pubDate>
</item>
</channel>
</rss>
